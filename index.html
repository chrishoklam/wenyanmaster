<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文言文背誦大師之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        /* 遊戲界面顏色 */
                        paper: {
                            light: '#f9f9ec',
                            dark: '#2a2a2a'
                        }
                    },
                    fontFamily: {
                        'sans': ['Noto Sans TC', 'sans-serif'],
                        'serif': ['"Noto Serif TC"', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;500;700&display=swap');
        
        body {
            overflow-x: hidden;
        }
        
        .book {
            perspective: 1200px;
        }
        
        .page {
            transform-origin: center left;
            transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1.000);
            transform-style: preserve-3d;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .page.turned {
            transform: rotateY(-180deg);
        }
        
        .page-content {
            backface-visibility: hidden;
        }
        
        .page-back {
            backface-visibility: hidden;
            transform: rotateY(180deg);
        }
        
        .character {
            animation: fadeIn 0.5s ease-in-out;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .dark .character {
            text-shadow: 0 2px 5px rgba(255, 255, 255, 0.2);
        }
        
        .option-btn {
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            animation: flyIn 0.6s cubic-bezier(0.19, 1, 0.22, 1) backwards;
            transform-style: preserve-3d;
            perspective: 1000px;
            position: relative;
            overflow: hidden;
        }
        
        .option-btn:nth-child(1) { animation-delay: 0s; }
        .option-btn:nth-child(2) { animation-delay: 0.1s; }
        .option-btn:nth-child(3) { animation-delay: 0.2s; }
        
        .option-btn:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: transform 0.7s;
        }
        
        .option-btn:hover:before {
            transform: rotate(30deg) translate(10%, 10%);
        }
        
        .option-btn:hover {
            transform: translateY(-3px) translateZ(20px) rotateX(10deg);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        
        @keyframes flyIn {
            0% {
                opacity: 0;
                transform: translateZ(-300px) scale(0.5) rotateX(20deg);
            }
            70% {
                opacity: 1;
                transform: translateZ(50px) scale(1.05) rotateX(-5deg);
            }
            100% {
                transform: translateZ(0) scale(1) rotateX(0);
            }
        }
        
        .option-btn.correct {
            background-color: rgba(34, 197, 94, 0.8);
            color: white;
            animation: correct-pulse 0.5s ease-in-out;
        }
        
        @keyframes correct-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        .option-btn.incorrect {
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        
        .dark .option-btn {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        
        .dark .page {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 墨滴效果 */
        .ink-drop {
            position: absolute;
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transform: scale(0);
            animation: inkSplash 2s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        
        .dark .ink-drop {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        @keyframes inkSplash {
            0% { transform: scale(0); opacity: 0.8; }
            70% { opacity: 0.3; }
            100% { transform: scale(15); opacity: 0; }
        }
        
        /* 屏幕震動效果 */
        .screen-shake {
            animation: screen-shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .game-over-shake {
            animation: game-over-shake 0.8s ease-in-out;
        }
        
        @keyframes game-over-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        /* 心跳動畫 */
        .animate-pulse {
            animation: heart-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes heart-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* 閃爍效果 */
        .animate-bounce {
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* 3D书本 */
        .book {
            transform-style: preserve-3d;
        }
        
        .book:after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
            transform: translateX(100%) rotateY(90deg);
            transform-origin: left;
        }
        
        /* 成就徽章樣式 */
        .achievement-seal {
            width: 100px;
            height: 100px;
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0 10px 15px;
            transform: rotate(-5deg);
        }
        
        .achievement-seal svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .seal-text {
            position: relative;
            z-index: 5;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            text-align: center;
            display: flex;
            flex-direction: column;
            color: #fff;
            line-height: 1.2;
        }
        
        .seal-title {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .seal-desc {
            font-size: 10px;
            opacity: 0.9;
        }
        
        .achievements-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        /* 暫停菜單動畫 */
        @keyframes pauseMenuAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        #pause-overlay > div {
            animation: pauseMenuAppear 0.3s ease-out;
        }
        
        /* 倒計時數字動畫 */
        .pause-countdown-number {
            animation: countdownPulse 1s ease-out;
        }
        
        @keyframes countdownPulse {
            0% { transform: scale(1.2); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
        
        /* 優化篇章列表和段落選擇器的滾動條樣式 */
        #passage-list, #paragraph-list, .paragraph-options {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }
        
        #passage-list::-webkit-scrollbar, #paragraph-list::-webkit-scrollbar, .paragraph-options::-webkit-scrollbar {
            width: 6px;
        }
        
        #passage-list::-webkit-scrollbar-track, #paragraph-list::-webkit-scrollbar-track, .paragraph-options::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #passage-list::-webkit-scrollbar-thumb, #paragraph-list::-webkit-scrollbar-thumb, .paragraph-options::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 6px;
        }
        
        /* 確保篇章和段落選擇器有合適的內距 */
        .passage-item, #paragraph-list > div {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        /* 確保可見性指示器 */
        .passage-item.hidden, #paragraph-selector.hidden {
            display: none;
        }
        
        /* 優化段落選項容器 */
        .paragraph-options {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 10px;
        }
        
        /* 改進確定按鈕樣式和位置 */
        #confirm-paragraphs {
            position: sticky;
            bottom: 0;
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            font-weight: 500;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
    </style>
    
    <!-- 慶祝動畫和載入動畫樣式 -->
    <style>
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* 墨水擴散動畫樣式 - 簡化版 */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(245, 242, 234, 1); /* 完全不透明背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* 更高的 z-index 確保覆蓋所有元素 */
            opacity: 0;
            animation: fadeIn 0.15s ease forwards;
            overflow: hidden;
        }
        
        #main-splash {
            position: absolute;
            width: 220px;
            height: 220px;
            top: 50%;
            left: 50%;
            background-color: rgba(0, 0, 0, 0.85);
            border-radius: 50%;
            transform-origin: center;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            animation: mainSplash 0.8s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        
        @keyframes mainSplash {
            0% { 
                transform: translate(-50%, -50%) scale(0); 
                opacity: 0.9;
                border-radius: 50%;
            }
            20% { 
                opacity: 0.8;
            }
            100% { 
                transform: translate(-50%, -50%) scale(4.5); 
                opacity: 0;
                border-radius: 48%;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .fade-out {
            animation: fadeOut 0.5s ease forwards;
        }
    </style>
</head>
<body class="bg-white font-serif min-h-screen bg-cover bg-center bg-fixed" style="background-image: url('https://i.imgur.com/7lKhK1s.png'); background-color: rgba(255, 255, 255, 0.8); background-blend-mode: overlay;">
    <!-- 暫停菜單覆蓋層 -->
    <div id="pause-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4 text-center">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">遊戲暫停</h2>
            
            <div id="pause-buttons" class="flex flex-col gap-4 mb-6">
                <button id="continue-btn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90">
                    繼續遊戲
                </button>
                <button id="restart-from-pause-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                    重新開始
                </button>
            </div>
            
            <!-- 隱藏的倒計時顯示 -->
            <div id="countdown-resume" class="hidden">
                <p class="text-gray-600 dark:text-gray-300 mb-3">遊戲將在以下時間後繼續</p>
                <div class="text-4xl font-bold text-primary pause-countdown-number">3</div>
            </div>
        </div>
    </div>

    <!-- 設置按鈕 - 絕對固定不滾動 -->
    <div id="settings-button" style="position: fixed; top: 16px; left: 16px; width: 48px; height: 48px; background-color: #92400e; color: white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;">
        <i class="fas fa-cog text-xl"></i>
    </div>
    
    <!-- 設置菜單 -->
    <div id="settings-menu" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">設置</h2>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex flex-col gap-3">
                <button data-section="help" class="settings-option py-3 px-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-question-circle text-primary mr-3"></i>
                    <span class="text-gray-800 dark:text-gray-200">遊玩說明</span>
                </button>
                <button data-section="records" class="settings-option py-3 px-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-trophy text-amber-500 mr-3"></i>
                    <span class="text-gray-800 dark:text-gray-200">我的記錄</span>
                </button>
                <button data-section="achievements" class="settings-option py-3 px-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-medal text-yellow-500 mr-3"></i>
                    <span class="text-gray-800 dark:text-gray-200">歷史成就</span>
                </button>
                <button data-section="version" class="settings-option py-3 px-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-code-branch text-green-500 mr-3"></i>
                    <span class="text-gray-800 dark:text-gray-200">版本資訊</span>
                </button>
                <button data-section="about" class="settings-option py-3 px-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-600">
                    <i class="fas fa-user text-blue-500 mr-3"></i>
                    <span class="text-gray-800 dark:text-gray-200">關於製作者</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 詳細信息模態框 -->
    <div id="info-modal" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-gray-800 py-2 z-10">
                <h3 id="info-modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-100"></h3>
                <button id="close-info-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="info-modal-content" class="text-gray-700 dark:text-gray-300"></div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">文言文背誦大師之旅</h1>
            <p class="text-gray-600 dark:text-gray-300 text-m">製作：@chl____chl</p>
        </header>
        
        <div class="passage-selector mb-6">
            <div id="passage-container" class="bg-amber-800 rounded-lg overflow-hidden transition-all duration-300 shadow-md z-50" style="max-height: 46px;">
                <div id="passage-header" class="flex justify-between items-center cursor-pointer p-3 text-white">
                    <h3 class="text-lg font-medium">選擇篇章</h3>
                    <i id="passage-toggle" class="fas fa-chevron-down transition-transform duration-300"></i>
                </div>
                <div id="passage-content" class="px-3 pb-3 hidden">
                    <div class="categories mb-3 flex flex-wrap gap-2 justify-between">
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="中一">中一</button>
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="中二">中二</button>
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="中三">中三</button>
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="指定文言">指定文言</button>
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="文學">文學</button>
                        <button class="category-btn p-2 bg-amber-100 dark:bg-amber-800 text-amber-900 dark:text-amber-100 rounded-md hover:bg-amber-200 dark:hover:bg-amber-700 text-sm flex-1" data-category="其他">其他</button>
                    </div>
                    <div id="passage-list" class="bg-white dark:bg-gray-800 rounded-md p-2 max-h-48 overflow-y-auto">
                        <!-- 篇章項目會在初始化時自動生成 -->
                        
                        <!-- 空分類提示信息 -->
                        <div id="empty-category-message" class="p-4 text-center hidden">
                            <i class="fas fa-info-circle text-amber-500 text-xl mb-2"></i>
                            <p class="text-gray-600 dark:text-gray-300">此分類暫無篇章，請選擇其他分類</p>
                        </div>
                    </div>
                    
                    <!--選擇區域段落 (默認隱藏) -->
                    <div id="paragraph-selector" class="mt-3 bg-white dark:bg-gray-800 rounded-md p-3 hidden">
                        <p class="text-gray-700 dark:text-gray-300 mb-2 font-medium">選擇背誦段落：</p>
                        <div id="paragraph-list" class="space-y-2">
                            <!-- 段落選項將在選擇篇章後動態生成 -->
                        </div>
                        <div class="mt-3">
                            <button id="confirm-paragraphs" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 text-base font-medium w-full">
                                確定
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        
        <div class="book relative mb-8">
            <div id="game-page" class="page rounded-lg overflow-hidden">
                <div class="page-content bg-paper-light dark:bg-paper-dark p-6 md:p-8 min-h-[400px] flex flex-col justify-between">
                    <!-- 遊戲控制區域 -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex flex-col gap-2">
                            <!-- 進度條 -->
                            <div class="w-full max-w-[200px]">
                                <div class="flex justify-between items-center text-xs text-gray-600 dark:text-gray-400 mb-1">
                                    <span>進度</span>
                                    <span id="progress-text">0 / <span id="total-chars">0</span></span>
                                </div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div id="progress-bar" class="h-full bg-primary rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- 生命值 -->
                            <div id="lives" class="flex text-red-500 dark:text-red-400 text-2xl">
                                <i class="fas fa-heart mx-0.5"></i>
                                <i class="fas fa-heart mx-0.5"></i>
                                <i class="fas fa-heart mx-0.5"></i>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="stopwatch" class="text-gray-700 dark:text-gray-300 px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-lg text-base flex items-center">
                                <i class="fas fa-stopwatch mr-2"></i><span id="timer" class="font-medium">00:00.0</span>
                            </div>
                            <!-- 將重新開始按鈕改為暫停按鈕 -->
                            <button id="pause-btn" class="p-2 bg-primary text-white rounded-lg hover:bg-opacity-90 text-xl flex items-center justify-center w-10 h-10" title="暫停遊戲">
                                <i class="fas fa-pause"></i>
                            </button>
                        </div>
                    </div>
                
                    <div class="text-center">
                        <div class="passage-info mb-4">
                            <h2 id="passage-title" class="text-xl font-bold text-gray-800 dark:text-gray-100">《論四端》</h2>
                            <p id="passage-author" class="text-gray-600 dark:text-gray-400">孟子</p>
                        </div>
                        
                        <div class="current-text my-6">
                            <div id="game-start-screen" class="flex flex-col items-center justify-center">
                                <div class="flex items-center justify-center gap-3">
                                    <button id="start-game-btn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transform hover:scale-105 transition-transform text-lg">
                                        開始
                                    </button>
                                    <button id="view-full-text-btn" class="p-3 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 flex items-center justify-center" title="查看完整文章">
                                        <i class="fas fa-search text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="game-content" class="hidden">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="flex items-center justify-center">
                                        <div id="last-answered-chars" class="text-lg md:text-xl text-gray-700 dark:text-gray-300 whitespace-nowrap overflow-x-auto max-w-full h-12 flex items-center"></div>
                                        <div id="current-char" class="character text-2xl md:text-3xl font-bold text-gray-900 dark:text-gray-100 min-w-[1.2em] flex items-center justify-center ml-1"></div>
                                        <div class="text-lg text-gray-400 dark:text-gray-500">...</div>
                                    </div>
                                    <div id="completed-text" class="hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="options-container" class="grid grid-cols-3 gap-3 md:gap-4 mb-4">
                        <!-- Options will be generated here -->
                    </div>
                    
                    <div id="feedback" class="text-center h-6 text-lg"></div>
                </div>
            </div>
        </div>
        
        <!-- 移除底部的遊玩說明按鈕，因為已經放在齒輪菜單中 -->
    </div>
    
    <!-- 版本號 -->
    <div class="text-center py-3 text-gray-500 dark:text-gray-400 text-sm">
        <p>v1.3</p>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 檢查系統深色模式並設置應用的模式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            // 監聽系統深色模式變化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // 添加視窗大小變化監聽
            window.addEventListener('resize', function() {
                // 如果篇章選擇器已打開
                if (passageContent && !passageContent.classList.contains('hidden')) {
                    const passageList = document.getElementById('passage-list');
                    if (passageList) {
                        passageList.style.maxHeight = Math.max(200, window.innerHeight * 0.4) + 'px';
                    }
                    
                    // 如果段落選擇器也打開
                    const paragraphSelector = document.getElementById('paragraph-selector');
                    const paragraphList = document.getElementById('paragraph-list');
                    if (paragraphSelector && !paragraphSelector.classList.contains('hidden') && paragraphList) {
                        // 調整段落選項容器的高度
                        const paragraphOptions = paragraphList.querySelector('.paragraph-options');
                        if (paragraphOptions) {
                            // 每段約70px高，最少200px，最多視口高度的50%
                            const paragraphCount = document.querySelectorAll('.paragraph-checkbox').length;
                            const calculatedHeight = Math.min(
                                Math.max(200, paragraphCount * 70),
                                window.innerHeight * 0.5
                            );
                            paragraphOptions.style.maxHeight = calculatedHeight + 'px';
                        }
                    }
                    
                    // 更新容器高度
                    if (passageContainer) {
                        // 計算當前所有內容的實際高度
                        const passageContentHeight = document.getElementById('passage-content').scrollHeight;
                        // 增加額外空間，確保容器高度充足
                        const totalHeight = Math.max(600, passageContentHeight + 50);
                        passageContainer.style.maxHeight = totalHeight + 'px';
                    }
                }
            });
            console.log("DOM加載完成，開始初始化...");
            
            // 新增暫停功能相關變量
            let isPaused = false;
            let resumeCountdown = null;
            
            // 添加追蹤用戶是否使用過暫停功能的變量
            let hasPaused = false;
            
            // 計時器相關變量 - 修改為支持暫停/繼續
            let startTime = null;
            let elapsedTimeBeforePause = 0; // 保存暫停前的累計時間
            let timerInterval = null;
            const timerElement = document.getElementById('timer');
            
            // 文言文數據 - 您可以在此處添加更多篇章
            const passages = {

                '人間詞話': {
                    title: '《人間詞話》（節錄）',
                    author: '王國維',
                    category: '中三',
                    paragraphs: [
                        '古今之成大事業、大學問者，必經過三種境界：「昨夜西風凋碧樹。獨上高樓，望盡天涯路。」此第一境界也。「衣帶漸寬終不悔，為伊消得人憔悴。」此第二境界也。「眾裡尋他千百度，驀然回首，那人卻在，燈火闌珊處。」此第三境界也。此等語皆非大詞人不能道。然遽以此意解釋諸詞，恐為晏、歐諸公所不許也。'
                    ]
                },

                '論四端': {
                    title: '《論四端》',
                    author: '孟子',
                    category: '中三',
                    paragraphs: [
                        '孟子曰：「人皆有不忍人之心。先王有不忍人之心，斯有不忍人之政矣。以不忍人之心，行不忍人之政，治天下可運之掌上。」',
                        '所以謂人皆有不忍人之心者，今人乍見孺子將入於井，皆有怵惕惻隱之心----非所以內交於孺子之父母也，非所以要譽於鄉黨朋友也，非惡其聲而然也。由是觀之，無惻隱之心，非人也；無羞惡之心，非人也；無辭讓之心，非人也；無是非之心，非人也。惻隱之心，仁之端也；羞惡之心，義之端也；辭讓之心，禮之端也；是非之心，智之端也。',
                        '人之有是四端也，猶其有四體也。有是四端而自謂不能者，自賊者也；謂其君不能者，賊其君者也。凡有四端於我者，知皆擴而充之矣，若火之始然，泉之始達。苟能充之，足以保四海；苟不充之，不足以事父母。」'
                    ]
                },

                '鄒忌諷齊王納諫': {
                    title: '《鄒忌諷齊王納諫》',
                    author: '戰國策',
                    category: '中三', 
                    paragraphs: [
                        '鄒忌脩八尺有餘，而形貌昳麗。朝服衣冠，窺鏡，謂其妻曰：「我孰與城北徐公美？」其妻曰：「君美甚，徐公何能及君也！」城北徐公，齊國之美麗者也。忌不自信，而復問其妾曰：「吾孰與徐公美？」妾曰：「徐公何能及君也！」旦日，客從外來，與坐談，問之客曰：「吾與徐公孰美？」客曰：「徐公不若君之美也。」明日，徐公來，孰視之，自以為不如；窺鏡而自視，又弗如遠甚。暮寢而思之，曰：「吾妻之美我者，私我也；妾之美我者，畏我也；客之美我者，欲有求於我也。」',
                        '於是入朝見威王，曰：「臣誠知不如徐公美。臣之妻私臣，臣之妾畏臣，臣之客欲有求於臣，皆以美於徐公。今齊地方千里，百二十城，宮婦左右，莫不私王；朝廷之臣，莫不畏王，四境之內，莫不有求於王。由此觀之，王之蔽甚矣。」王曰：「善。」乃下令：「羣臣吏民能面刺寡人之過者，受上賞；上書諫寡人者，受中賞；能謗議於市朝，聞寡人之耳者，受下賞。」',
                        '令初下，羣臣進諫，門庭若市；數月之後，時時而間進；期年之後，雖欲言，無可進者。燕、趙、韓、魏聞之，皆朝於齊。此所謂戰勝於朝廷。'
                    ]
                },

                '論仁論孝論君子': {
                    title: '《論仁論孝論君子》',
                    author: '論語',
                    category: '指定文言',
                    paragraphs: [
                        '子曰：「不仁者，不可以久處約，不可以長處樂。仁者安仁，知者利仁。」',
                        '子曰：「富與貴，是人之所欲也；不以其道得之，不處也。貧與賤，是人之所惡也；不以其道得之，不去也。君子去仁，惡乎成名？君子無終食之間違仁，造次必於是，顛沛必於是。」',
                        '顏淵問仁。子曰：「克己復禮為仁。一日克己復禮，天下歸仁焉。為仁由己，而由人乎哉？」顏淵曰：「請問其目。」子曰：「非禮勿視，非禮勿聽，非禮勿言，非禮勿動。」顏淵曰：「回雖不敏，請事斯語矣。」',
                        '子曰：「志士仁人，無求生以害仁，有殺身以成仁。」',
                        '孟懿子問孝。子曰：「無違。」樊遲御，子告之曰：「孟孫問孝於我，我對曰，無違。」樊遲曰：「何謂也？」子曰：「生，事之以禮；死，葬之以禮，祭之以禮。',
                        '子游問孝。子曰：「今之孝者，是謂能養。至於犬馬，皆能有養；不敬，何以別乎！」',
                        '子曰：「事父母幾諫，見志不從，又敬不違，勞而不怨。」',
                        '子曰：「父母之年，不可不知也。一則以喜，一則以懼。」',
                        '子曰：「君子不重則不威；學則不固。主忠信。無友不如己者。過則勿憚改。」',
                        '子曰：「君子坦蕩蕩，小人長戚戚。」',
                        '司馬牛問君子。子曰：「君子不憂不懼。」曰：「不憂不懼，斯謂之君子已乎？」子曰：「內省不疚，夫何憂何懼？」',
                        '子曰：「君子成人之美，不成人之惡。小人反是。」',
                        '子曰：「君子恥其言而過其行。」',
                        '子曰：「君子義以為質，禮以行之，孫以出之，信以成之。君子哉！」',
                        '子曰：「君子病無能焉，不病人之不己知也。」',
                        '子曰：「君子求諸己，小人求諸人。」'
                    ]
                },

                '魚我所欲也': {
                    title: '《魚我所欲也》',
                    author: '孟子',
                    category: '指定文言',
                    paragraphs: [
                        '孟子曰：「魚，我所欲也，熊掌，亦我所欲也；二者不可得兼，舍魚而取熊掌者也。生亦我所欲也，義亦我所欲也；二者不可得兼，舍生而取義者也。生亦我所欲，所欲有甚於生者，故不為苟得也；死亦我所惡，所惡有甚於死者，故患有所不辟也。如使人之所欲莫甚於生，則凡可以得生者，何不用也？使人之所惡莫甚於死者，則凡可以辟患者，何不為也？由是則生而有不用也，由是則可以辟患而有不為也，是故所欲有甚於生者，所惡有甚於死者。非獨賢者有是心也，人皆有之，賢者能勿喪耳。',
                        '一簞食，一豆羹，得之則生，弗得則死。嘑爾而與之，行道之人弗受；蹴爾而與之，乞人不屑也；萬鍾則不辯禮義而受之。萬鍾於我何加焉？為宮室之美、妻妾之奉、所識窮乏者得我與？鄉為身死而不受，今為宮室之美為之；鄉為身死而不受，今為妻妾之奉為之；鄉為身死而不受，今為所識窮乏者得我而為之，是亦不可以已乎？此之謂失其本心。」'
                    ]
                },

                '勸學': {
                    title: '《勸學》（節錄）',
                    author: '荀子',
                    category: '指定文言',
                    paragraphs: [
                        '君子曰：學不可以已。青，取之於藍，而青於藍；冰，水為之，而寒於水。木直中繩，輮以為輪，其曲中規；雖有槁暴、不復挺者，輮使之然也。故木受繩則直，金就礪則利，君子博學而日參省乎己，則知明而行無過矣。',
                        '吾嘗終日而思矣，不如須臾之所學也；吾嘗跂而望矣，不如登高之博見也。登高而招，臂非加長也，而見者遠。順風而呼，聲非加疾也，而聞者彰。假輿馬者，非利足也，而致千里；假舟楫者，非能水也，而絕江河。君子生非異也，善假於物也。',
                        '積土成山，風雨興焉；積水成淵，蛟龍生焉；積善成德，而神明自得，聖心備焉。故不積跬步，無以至千里；不積小流，無以成江海。騏驥一躍，不能十步；駑馬十駕，功在不舍。鍥而舍之，朽木不折；鍥而不舍，金石可鏤。螾無爪牙之利，筋骨之強，上食埃土，下飲黃泉，用心一也。蟹六跪而二螯，非蛇蟺之穴無可寄託者，用心躁也。'
                    ]
                },
                
                '師說': {
                    title: '《師說》（節錄）',
                    author: '韓愈',
                    category: '指定文言',
                    paragraphs: [
                        '古之學者必有師。師者，所以傳道、受業、解惑也。人非生而知之者，孰能無惑？惑而不從師，其為惑也終不解矣。生乎吾前，其聞道也，固先乎吾，吾從而師之；生乎吾後，其聞道也，亦先乎吾，吾從而師之。吾師道也，夫庸知其年之先後生於吾乎？是故無貴無賤，無長無少，道之所存，師之所存也。',
                        '嗟乎！師道之不傳也久矣！欲人之無惑也難矣！古之聖人，其出人也遠矣，猶且從師而問焉；今之眾人，其下聖人也亦遠矣，而恥學於師。是故聖益聖，愚益愚，聖人之所以為聖，愚人之所以為愚，其皆出於此乎！',
                        '愛其子，擇師而教之；於其身也，則恥師焉，惑矣！彼童子之師，授之書而習其句讀者，非吾所謂傳其道、解其惑者也。句讀之不知，惑之不解，或師焉，或不焉，小學而大遺，吾未見其明也。',
                        '巫、醫、樂師、百工之人，不恥相師；士大夫之族，曰師、曰弟子云者，則羣聚而笑之。問之，則曰：「彼與彼年相若也，道相似也。」位卑則足羞，官盛則近諛。嗚呼！師道之不復，可知矣。巫、醫、樂師、百工之人，君子不齒，今其智乃反不能及，其可怪也歟！',
                        '聖人無常師，孔子師郯子、萇弘、師襄、老聃。郯子之徒，其賢不及孔子。孔子曰：「三人行，則必有我師。」是故弟子不必不如師，師不必賢於弟子；聞道有先後，術業有專攻，如是而已。',
                        '李氏子蟠，年十七，好古文，六藝經傳，皆通習之，不拘於時，學於余。余嘉其能行古道，作《師說》以貽之。'
                    ]
                },

                '岳陽樓記': {
                    title: '《岳陽樓記》',
                    author: '范仲淹',
                    category: '指定文言', 
                    paragraphs: [
                        '慶曆四年春，滕子京謫守巴陵郡。越明年，政通人和，百廢具興，乃重修岳陽樓，增其舊制，刻唐賢今人詩賦於其上；屬予作文以記之。',
                        '予觀夫巴陵勝狀，在洞庭一湖。銜遠山，吞長江，浩浩湯湯，橫無際涯；朝暉夕陰，氣象萬千；此則岳陽樓之大觀也，前人之述備矣。然則北通巫峽，南極瀟湘，遷客騷人，多會於此，覽物之情，得無異乎？',
                        '若夫霪雨霏霏，連月不開；陰風怒號，濁浪排空；日星隱曜，山嶽潛形；商旅不行，檣傾楫摧；薄暮冥冥，虎嘯猿啼。登斯樓也，則有去國懷鄉，憂讒畏譏，滿目蕭然，感極而悲者矣。',
                        '至若春和景明，波瀾不驚，上下天光，一碧萬頃；沙鷗翔集，錦鱗游泳，岸芷汀蘭，郁郁青青。而或長煙一空，皓月千里，浮光躍金，靜影沉璧，漁歌互答，此樂何極。登斯樓也，則有心曠神怡，寵辱皆忘，把酒臨風，其喜洋洋者矣。',
                        '嗟夫！予嘗求古仁人之心，或異二者之為，何哉？不以物喜，不以己悲。居廟堂之高，則憂其民；處江湖之遠，則憂其君。是進亦憂，退亦憂；然則何時而樂耶？其必曰：「先天下之憂而憂，後天下之樂而樂」歟！噫！微斯人，吾誰與歸？'
                    ]
                },

                '六國論': {
                    title: '《六國論》',
                    author: '蘇洵',
                    category: '指定文言', 
                    paragraphs: [
                        '六國破滅，非兵不利，戰不善，弊在賂秦。賂秦而力虧，破滅之道也。或曰：「六國互喪，率賂秦耶？」曰：「不賂者以賂者喪。蓋失強援，不能獨完，故曰『弊在賂秦』也。」',
                        '秦以攻取之外，小則獲邑，大則得城，較秦之所得與戰勝而得者，其實百倍；諸侯之所亡與戰敗而亡者，其實亦百倍。則秦之所大欲，諸侯之所大患，固不在戰矣。思厥先祖父，暴霜露，斬荊棘，以有尺寸之地。子孫視之不甚惜，舉以予人，如棄草芥。今日割五城，明日割十城，然後得一夕安寢，起視四境，而秦兵又至矣。然則諸侯之地有限，暴秦之欲無厭，奉之彌繁，侵之愈急，故不戰而強弱勝負已判矣。至於顛覆，理固宜然。古人云：「以地事秦，猶抱薪救火，薪不盡，火不滅。」此言得之。',
                        '齊人未嘗賂秦，終繼五國遷滅，何哉？與嬴而不助五國也。五國既喪，齊亦不免矣。燕趙之君，始有遠略，能守其土，義不賂秦。是故燕雖小國而後亡，斯用兵之效也。至丹以荊卿為計，始速禍焉。趙嘗五戰于秦，二敗而三勝，後秦擊趙者再，李牧連卻之；洎牧以讒誅，邯鄲為郡，惜其用武而不終也。且燕趙處秦革滅殆盡之際，可謂智力孤危，戰敗而亡，誠不得已。向使三國各愛其地，齊人勿附於秦，刺客不行，良將猶在，則勝負之數，存亡之理，當與秦相較，或未易量。',
                        '嗚呼！以賂秦之地，封天下之謀臣；以事秦之心，禮天下之奇才；幷力西嚮，則吾恐秦人食之不得下嚥也。悲夫！有如此之勢，而為秦人積威之所劫，日削月割，以趨於亡。為國者無使為積威之所劫哉！',
                        '夫六國與秦皆諸侯，其勢弱於秦，而猶有可以不賂而勝之之勢；茍以天下之大，而從六國破亡之故事，是又在六國下矣！'
                    ]
                },

                // 在這裡添加更多篇章...
                // 新增篇章格式:
                /*
                '篇章鍵值': {
                    title: '《篇章標題》',
                    author: '作者',
                    category: '分類名稱',  // 從現有分類中選擇或創建新分類
                    paragraphs: [
                        '第一段內容...',
                        '第二段內容...',
                        // 更多段落...
                    ]
                },
                */
            };
            
            // 自動生成內容和初始化
            initializePassages();
            
            // 定义全局变量
            const startGameBtn = document.getElementById('start-game-btn');
            const gameStartScreen = document.getElementById('game-start-screen');
            const gameContent = document.getElementById('game-content');
            const gamePage = document.getElementById('game-page');
            
            // 当前选择的篇章键值，初始设定为一个随機篇章
            let currentPassageKey = '';
            
            // 函數：隨機選擇篇章並加載
            function loadRandomPassage() {
                // 獲取所有篇章的鍵值
                const passageKeys = Object.keys(passages);
                if (passageKeys.length === 0) return;
                
                // 隨機選擇一個篇章
                const randomIndex = Math.floor(Math.random() * passageKeys.length);
                const randomPassageKey = passageKeys[randomIndex];
                currentPassageKey = randomPassageKey;
                
                // 獲取所有段落索引
                const selectedPassage = passages[randomPassageKey];
                const paragraphIndices = [];
                for (let i = 0; i < selectedPassage.paragraphs.length; i++) {
                    paragraphIndices.push(i);
                }
                
                // 加載選中的篇章（所有段落）
                loadSelectedParagraphs(randomPassageKey, paragraphIndices);
            }
            
            // 頁面加載後自動選擇一個隨機篇章，但保持在開始畫面
            setTimeout(() => {
                // 加載隨機篇章，但不自動開始遊戲
                loadRandomPassage();
                
                // 確保顯示開始畫面
                if (gameStartScreen && gameContent) {
                    gameStartScreen.classList.remove('hidden');
                    gameContent.classList.add('hidden');
                }
            }, 300);
            
            // 追蹤錯誤次數
            let wrongAnswersCount = 0;
            
            // 创建倒计时容器
            const countdownContainer = document.createElement('div');
            countdownContainer.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden';
            countdownContainer.id = 'countdown-container';
            document.body.appendChild(countdownContainer);
            
            const countdownNumber = document.createElement('div');
            countdownNumber.className = 'text-8xl md:text-9xl font-bold text-white countdown-number';
            countdownContainer.appendChild(countdownNumber);
            
            // 添加倒计时样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes countdown-pulse {
                    0% { transform: scale(0.8); opacity: 0; }
                    20% { transform: scale(1.2); opacity: 1; }
                    70% { transform: scale(0.9); opacity: 1; }
                    100% { transform: scale(1); opacity: 0.7; }
                }
                .countdown-number {
                    animation: countdown-pulse 1s ease-in-out;
                    text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 30px rgba(93, 92, 222, 0.6);
                }
            `;
            document.head.appendChild(style);
            
            // 初始化暫停功能
            initializePauseSystem();
            
            // 自動生成篇章列表
            generatePassageItems();
            
            // 开始游戏按钮事件
            if (startGameBtn) {
                startGameBtn.addEventListener('click', function() {
                    gameStartScreen.classList.add('hidden');
                    countdownContainer.classList.remove('hidden');
                    
                    // 確保選擇背誦段落界面關閉
                    passageContent.classList.add('hidden');
                    passageToggle.style.transform = 'rotate(0deg)';
                    passageContainer.style.maxHeight = '46px';
                    
                    // 重置暫停狀態
                    hasPaused = false;
                    
                    let countdown = 3;
                    
                    // 显示倒计时
                    function showCountdown() {
                        if (countdown > 0) {
                            countdownNumber.textContent = countdown;
                            countdownNumber.style.animation = 'none';
                            void countdownNumber.offsetWidth; // 重置动画
                            countdownNumber.style.animation = 'countdown-pulse 1s ease-in-out';
                            
                            countdown--;
                            setTimeout(showCountdown, 1000);
                        } else {
                            // 倒计时结束，显示"开始！"
                            countdownNumber.textContent = '開始！';
                            countdownNumber.style.animation = 'none';
                            void countdownNumber.offsetWidth;
                            countdownNumber.style.animation = 'countdown-pulse 0.7s ease-in-out';
                            
                            // 开始游戏
                            setTimeout(function() {
                                countdownContainer.classList.add('hidden');
                                gameContent.classList.remove('hidden');
                                
                                // 重置並開始秒表 (確保從0開始)
                                elapsedTimeBeforePause = 0; // 重置累計時間
                                resetStopwatch();
                                
                                // 显示游戏内容
                                updateDisplay();
                            }, 800);
                        }
                    }
                    
                    showCountdown();
                });
            } else {
                console.error("開始遊戲按鈕未找到");
            }
            
            // 选择篇章功能
            const passageContainer = document.getElementById('passage-container');
            const passageHeader = document.getElementById('passage-header');
            const passageToggle = document.getElementById('passage-toggle');
            const passageContent = document.getElementById('passage-content');
            const categoryBtns = document.querySelectorAll('.category-btn');
            const passageList = document.getElementById('passage-list');
            
// 完整的事件監聽函數替換
if (passageHeader && passageToggle && passageContent) {
    // 篇章選擇器默認關閉
    // 用戶需要點擊才會打開
    
    // 切换篇章选择器
    passageHeader.addEventListener('click', function() {
        console.log("篇章標頭被點擊");
        
        if (passageContent.classList.contains('hidden')) {
            // 打開篇章選擇器
            console.log("打開篇章選擇器");
            passageContent.classList.remove('hidden');
            passageToggle.style.transform = 'rotate(180deg)';
            
            // 添加更自然的開啟動畫效果
            passageContent.style.opacity = '0';
            passageContent.style.transform = 'translateY(-20px)';
            passageContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            passageContainer.style.transition = 'max-height 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
            passageContainer.style.maxHeight = '500px'; // 立即設置足夠的高度
            
            // 觸發重繪並應用動畫
            setTimeout(() => {
                passageContent.style.opacity = '1';
                passageContent.style.transform = 'translateY(0)';
            }, 50);
            
            // 首次打開時不默認選中任何分類，篇章列表為空
            const hasSelectedBefore = currentPassageKey && currentPassageKey.length > 0;
            
            if (hasSelectedBefore) {
                // 如果已有選擇的篇章，則自動打開段落選擇器
                // 找到並激活當前選擇的篇章項目
                const passageItems = document.querySelectorAll('.passage-item');
                passageItems.forEach(item => {
                    if (item.dataset.value === currentPassageKey) {
                        // 移除所有篇章的active樣式
                        passageItems.forEach(i => 
                            i.classList.remove('active', 'bg-amber-100', 'dark:bg-amber-900'));
                        
                        // 添加當前篇章的active樣式
                        item.classList.add('active', 'bg-amber-100', 'dark:bg-amber-900');
                        
                        // 顯示該篇章的段落選擇器
                        const paragraphSelector = document.getElementById('paragraph-selector');
                        if (paragraphSelector && paragraphSelector.classList.contains('hidden')) {
                            // 只有在段落選擇器隱藏時才調用，避免重複加載
                            showParagraphSelector(currentPassageKey);
                        }
                        
                        // 如果篇章項目當前是隱藏的，則打開其所屬的分類
                        if (item.classList.contains('hidden')) {
                            const category = item.dataset.category;
                            // 找到並激活對應的分類按鈕
                            categoryBtns.forEach(btn => {
                                if (btn.dataset.category === category) {
                                    // 移除所有按鈕的active樣式
                                    categoryBtns.forEach(b => b.classList.remove('active', 'bg-amber-200', 'dark:bg-amber-700'));
                                    
                                    // 添加當前按鈕的active樣式
                                    btn.classList.add('active', 'bg-amber-200', 'dark:bg-amber-700');
                                    
                                    // 顯示該分類下的所有篇章
                                    passageItems.forEach(i => {
                                        if (i.dataset.category === category) {
                                            i.classList.remove('hidden');
                                        } else {
                                            i.classList.add('hidden');
                                        }
                                    });
                                }
                            });
                        }
                    }
                });
            }
        } else {
            // 關閉篇章選擇器 - 添加收縮動畫
            console.log("關閉篇章選擇器");
            passageToggle.style.transform = 'rotate(0deg)';
            
            // 添加淡出動畫效果
            passageContent.style.opacity = '0';
            passageContent.style.transform = 'translateY(10px)';
            
            // 先收縮容器高度，然後隱藏內容
            passageContainer.style.transition = 'max-height 0.4s cubic-bezier(0.6, 0.04, 0.98, 0.335)';
            passageContainer.style.maxHeight = '46px';
            
            // 延遲隱藏內容，讓收縮動畫先完成
            setTimeout(() => {
                passageContent.classList.add('hidden');
                
                // 重置動畫狀態，為下次打開做準備
                setTimeout(() => {
                    passageContent.style.transition = 'none';
                    passageContent.style.opacity = '1';
                    passageContent.style.transform = 'translateY(0)';
                }, 50);
                
                // 強制隱藏段落選擇器
                const paragraphSelector = document.getElementById('paragraph-selector');
                if (paragraphSelector) {
                    console.log("隱藏段落選擇器");
                    paragraphSelector.classList.add('hidden');
                    
                    // 重置段落選擇器動畫狀態
                    setTimeout(() => {
                        paragraphSelector.style.transition = 'none';
                        paragraphSelector.style.opacity = '1';
                        paragraphSelector.style.transform = 'translateY(0)';
                    }, 50);
                } else {
                    console.error("找不到段落選擇器元素");
                }
            }, 300); // 等待收縮動畫完成
        }
    });
}            
            // 分类按钮点击事件
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除所有按钮的active样式
                    categoryBtns.forEach(b => b.classList.remove('active', 'bg-amber-200', 'dark:bg-amber-700'));
                    
                    // 添加当前按钮的active样式
                    this.classList.add('active', 'bg-amber-200', 'dark:bg-amber-700');
                    
                    // 過濾篇章列表
                    const category = this.dataset.category;
                    const passageItems = document.querySelectorAll('.passage-item');
                    const emptyMessage = document.getElementById('empty-category-message');
                    
                    if (!emptyMessage) {
                        console.error("空分類提示元素未找到");
                        return;
                    }
                    
                    // 先隱藏所有篇章和提示信息
                    passageItems.forEach(item => {
                        item.classList.add('hidden');
                    });
                    emptyMessage.classList.add('hidden');
                    
                    // 檢查顯示符合分類的篇章
                    let hasVisibleItems = false;
                    passageItems.forEach(item => {
                        if (item.dataset.category === category) {
                            item.classList.remove('hidden');
                            hasVisibleItems = true;
                        }
                    });
                    
                    // 如果該分類沒有篇章，顯示提示信息
                    if (!hasVisibleItems) {
                        emptyMessage.classList.remove('hidden');
                    }
                    
                    // 隐藏段落选择器
                    const paragraphSelector = document.getElementById('paragraph-selector');
                    if (paragraphSelector) {
                        paragraphSelector.classList.add('hidden');
                    }
                    
                    // 確保篇章列表容器有足夠高度並可滾動
                    const passageList = document.getElementById('passage-list');
                    if (passageList) {
                        // 計算合適的最大高度 (視口高度的40%)
                        const maxHeight = Math.max(200, window.innerHeight * 0.4) + 'px';
                        passageList.style.maxHeight = maxHeight;
                        
                        // 確保容器可滾動
                        passageList.style.overflowY = 'auto';
                    }
                    
                    // 確保主容器有足夠空間顯示列表
                    if (passageContainer) {
                        // 視口高度的60%，但至少600px
                        passageContainer.style.maxHeight = Math.max(600, window.innerHeight * 0.6) + 'px';
                    }
                });
            });
            
            // 自動生成篇章項目的函數
            function generatePassageItems() {
                const container = document.getElementById('passage-list');
                if (!container) {
                    console.error("篇章列表容器未找到");
                    return;
                }
                
                // 保存空分類提示消息
                const emptyMessage = document.getElementById('empty-category-message');
                let savedEmptyMsg = null;
                if (emptyMessage) {
                    savedEmptyMsg = emptyMessage.cloneNode(true);
                }
                
                // 清空容器
                container.innerHTML = '';
                
                // 恢復空分類提示消息
                if (savedEmptyMsg) {
                    container.appendChild(savedEmptyMsg);
                }
                
                // 為每個篇章創建項目
                Object.keys(passages).forEach(key => {
                    const passage = passages[key];
                    
                    // 創建篇章項目元素
                    const item = document.createElement('div');
                    item.className = 'passage-item p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md cursor-pointer hidden';
                    item.dataset.value = key;
                    item.dataset.category = passage.category || '其他'; // 使用篇章中定義的分類
                    item.textContent = `${passage.title} - ${passage.author}`;
                    
                    // 添加到容器中
                    container.appendChild(item);
                });
                
                // 添加篇章項目的點擊事件
                addPassageItemListeners();
            }
            
            // 为篇章项添加点击事件监听
            function addPassageItemListeners() {
                document.querySelectorAll('.passage-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // 移除所有篇章的active样式
                        document.querySelectorAll('.passage-item').forEach(i => 
                            i.classList.remove('active', 'bg-amber-100', 'dark:bg-amber-900'));
                        
                        // 添加当前篇章的active样式
                        this.classList.add('active', 'bg-amber-100', 'dark:bg-amber-900');
                        
                        // 获取选中的篇章
                        const passageKey = this.dataset.value;
                        currentPassageKey = passageKey;
                        
                        // 显示段落选择器
                        showParagraphSelector(passageKey);
                    });
                });
            }
            
            // 自動為所有篇章生成內容
            function initializePassages() {
                Object.keys(passages).forEach(key => {
                    if (!passages[key].content) {
                        passages[key].content = passages[key].paragraphs.join('');
                    }
                });
            }
            
            // 显示段落选择器
            function showParagraphSelector(passageKey) {
                // 添加动画效果 - 用于段落选择器的打开过渡
                const paragraphSelector = document.getElementById('paragraph-selector');
                const paragraphList = document.getElementById('paragraph-list');
                const selectedPassage = passages[passageKey];
                
                if (!paragraphSelector || !paragraphList) {
                    console.error("段落選擇器元素未找到");
                    return;
                }
                
                if (!selectedPassage) {
                    console.error("選中的篇章不存在:", passageKey);
                    return;
                }
                
                // 清空段落列表
                paragraphList.innerHTML = '';
                
                // 添加"全文"选项
                const allOption = document.createElement('div');
                allOption.className = 'flex items-center mb-2';
                allOption.innerHTML = `
                    <input type="checkbox" id="paragraph-all" class="mr-2 h-4 w-4 text-primary" checked>
                    <label for="paragraph-all" class="text-gray-700 dark:text-gray-300 cursor-pointer font-medium">全文</label>
                `;
                paragraphList.appendChild(allOption);
                
                // 全选按钮逻辑
                const allCheckbox = allOption.querySelector('input');
                if (allCheckbox) {
                    allCheckbox.addEventListener('change', function() {
                        // 获取所有段落复选框
                        const paragraphCheckboxes = paragraphOptionsContainer.querySelectorAll('.paragraph-checkbox');
                        
                        // 设置所有段落复选框与全选框状态一致
                        paragraphCheckboxes.forEach(checkbox => {
                            checkbox.checked = this.checked;
                        });
                    });
                }
                
                // 创建包含所有段落选项的容器
                const paragraphOptionsContainer = document.createElement('div');
                paragraphOptionsContainer.className = 'paragraph-options overflow-y-auto';
                paragraphList.appendChild(paragraphOptionsContainer);
                
                // 添加各段落选项
                selectedPassage.paragraphs.forEach((paragraph, index) => {
                    const paragraphOption = document.createElement('div');
                    paragraphOption.className = 'flex items-center mb-2';
                    paragraphOption.innerHTML = `
                        <input type="checkbox" id="paragraph-${index+1}" class="mr-2 h-4 w-4 text-primary paragraph-checkbox" data-index="${index}" checked>
                        <label for="paragraph-${index+1}" class="text-gray-700 dark:text-gray-300 cursor-pointer flex-1">
                            <span class="font-medium">第${index+1}段：</span>
                            <span class="text-sm">${paragraph.substring(0, 20)}${paragraph.length > 20 ? '...' : ''}</span>
                        </label>
                    `;
                    paragraphOptionsContainer.appendChild(paragraphOption);
                    
                    // 段落复选框逻辑
                    const checkbox = paragraphOption.querySelector('input');
                    if (checkbox) {
                        checkbox.addEventListener('change', function() {
                            // 检查是否所有段落都被选中
                            const paragraphCheckboxes = paragraphOptionsContainer.querySelectorAll('.paragraph-checkbox');
                            const allCheckbox = document.getElementById('paragraph-all');
                            
                            if (allCheckbox && paragraphCheckboxes) {
                                const allChecked = Array.from(paragraphCheckboxes).every(cb => cb.checked);
                                allCheckbox.checked = allChecked;
                            }
                        });
                    }
                });
                
                // 显示段落选择器
                // 先置頂，避免顯示延遲
                paragraphSelector.style.cssText = 'transform: translateY(-20px); opacity: 0;';
                paragraphSelector.classList.remove('hidden');
                
                // 強制觸發重繪
                void paragraphSelector.offsetWidth;
                
                // 應用動畫 - 較長的過渡時間提供更流暢的體驗
                paragraphSelector.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease-out';
                paragraphSelector.style.transform = 'translateY(0)';
                paragraphSelector.style.opacity = '1';
                
                // 設置段落列表的滾動屬性
                if (paragraphOptionsContainer) {
                    // 根據段落數量動態調整高度，增加每段高度並提高最小值
                    const paragraphCount = selectedPassage.paragraphs.length;
                    // 每段約70px高，最少200px，最多視口高度的50%
                    const calculatedHeight = Math.min(
                        Math.max(200, paragraphCount * 70),
                        window.innerHeight * 0.5
                    );
                    paragraphOptionsContainer.style.maxHeight = calculatedHeight + 'px';
                    paragraphOptionsContainer.style.overflowY = 'auto';
                }
                
                // 確保容器高度足夠 - 使用動態計算的高度
                if (passageContainer) {
                    // 計算當前所有內容的實際高度，包括段落選擇器和確認按鈕
                    const paragraphSelectorHeight = paragraphSelector.scrollHeight;
                    const passageContentHeight = document.getElementById('passage-content').scrollHeight;
                    // 增加額外空間，確保容器高度充足
                    const totalHeight = Math.max(600, passageContentHeight + 50);
                    passageContainer.style.maxHeight = totalHeight + 'px';
                    passageContainer.style.transition = 'max-height 0.3s ease';
                }
                
                // 重新绑定确认按钮事件
                setupConfirmButton();
            }
            
            // 設置確認按鈕事件
            function setupConfirmButton() {
                const confirmBtn = document.getElementById('confirm-paragraphs');
                if (!confirmBtn) {
                    console.error("確認按鈕元素未找到");
                    return;
                }
                
                // 移除現有的事件監聽器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // 添加新的事件監聽器
                newConfirmBtn.addEventListener('click', function() {
                    console.log("確認按鈕被點擊");
                    
                    const paragraphList = document.getElementById('paragraph-list');
                    if (!paragraphList) {
                        console.error("段落列表元素未找到");
                        return;
                    }
                    
                    // 获取选中的段落索引
                    const selectedIndices = [];
                    const paragraphOptions = paragraphList.querySelector('.paragraph-options');
                    if (!paragraphOptions) {
                        console.error("段落選項容器未找到");
                        return;
                    }
                    
                    const checkboxes = paragraphOptions.querySelectorAll('.paragraph-checkbox');
                    
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            selectedIndices.push(parseInt(checkbox.dataset.index));
                        }
                    });
                    
                    // 如果没有选中任何段落，默认选中全部
                    if (selectedIndices.length === 0) {
                        if (passages[currentPassageKey]) {
                            for (let i = 0; i < passages[currentPassageKey].paragraphs.length; i++) {
                                selectedIndices.push(i);
                            }
                        }
                    }
                    
                    console.log("選中的段落索引:", selectedIndices);
                    
                    // 关闭选择器
                    if (passageContent) {
                        passageContent.classList.add('hidden');
                    }
                    if (passageToggle) {
                        passageToggle.style.transform = 'rotate(0deg)';
                    }
                    if (passageContainer) {
                        passageContainer.style.maxHeight = '46px';
                    }
                    
                    // 載入選中的段落
                    loadSelectedParagraphs(currentPassageKey, selectedIndices);
                });
            }
            
            // 用于存储已回答的字符
            let lastAnsweredChars = [];
            const MAX_DISPLAYED_CHARS = 15;
            
            // 成功背誦50字恢復1點生命值的計數器
            let successfulChars = 0;
            
            // 遊戲當前使用的內容
            let content = '';
            let totalNonPunctChars = 0;
            
            // 創建查看完整文章的功能
            const fullTextModal = document.createElement('div');
            fullTextModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
            fullTextModal.id = 'full-text-modal';
            document.body.appendChild(fullTextModal);
            
            // 加載選中段落的函數，不使用水墨過渡動畫
            async function loadSelectedParagraphs(passageKey, paragraphIndices) {
                console.log("開始加載段落:", passageKey, paragraphIndices);
                
                try {
                    
                    // 確保遊戲頁面存在
                    const gamePage = document.getElementById('game-page');
                    if (!gamePage) {
                        console.error("遊戲頁面元素未找到");
                        return;
                    }
                    
                    // 重置游戏状态
                    currentPosition = 0;
                    correctAnswers = 0;
                    wrongAnswersCount = 0; // 重置錯誤計數
                    lives = 3;
                    updateLives();
                    
                    const lastAnsweredCharsElem = document.getElementById('last-answered-chars');
                    if (lastAnsweredCharsElem) {
                        lastAnsweredChars = [];
                        lastAnsweredCharsElem.textContent = '';
                    }
                    
                    const completedText = document.getElementById('completed-text');
                    if (completedText) {
                        completedText.textContent = '';
                    }
                    
                    // 獲取選擇的篇章
                    const selectedPassage = passages[passageKey];
                    if (!selectedPassage) {
                        console.error("選中的篇章不存在:", passageKey);
                        return;
                    }
                    
                    // 根据选择的段落索引构建内容
                    content = '';
                    paragraphIndices.sort((a, b) => a - b); // 确保段落按顺序排列
                    
                    paragraphIndices.forEach(index => {
                        if (index >= 0 && index < selectedPassage.paragraphs.length) {
                            content += selectedPassage.paragraphs[index];
                        }
                    });
                    
                    // 計算非標點符號的字符數量
                    totalNonPunctChars = 0;
                    for (let i = 0; i < content.length; i++) {
                        if (!isPunctuation(content[i])) {
                            totalNonPunctChars++;
                        }
                    }
                    
                    console.log("字數計算完成，總非標點字符數：", totalNonPunctChars);
                    
                    // 构建标题（添加所选段落信息）
                    const passageTitle = document.getElementById('passage-title');
                    const passageAuthor = document.getElementById('passage-author');
                    
                    if (passageTitle) {
                        if (paragraphIndices.length === selectedPassage.paragraphs.length) {
                            // 如果選擇了所有段落，只顯示標題
                            passageTitle.textContent = selectedPassage.title;
                        } else {
                            // 如果選擇了部分段落，顯示段落範圍
                            let rangeText = '';
                            if (paragraphIndices.length === 1) {
                                rangeText = `第${paragraphIndices[0] + 1}段`;
                            } else {
                                // 判断是否是连续的段落
                                let isConsecutive = true;
                                for (let i = 0; i < paragraphIndices.length - 1; i++) {
                                    if (paragraphIndices[i + 1] !== paragraphIndices[i] + 1) {
                                        isConsecutive = false;
                                        break;
                                    }
                                }
                                
                                if (isConsecutive) {
                                    rangeText = `第${paragraphIndices[0] + 1}-${paragraphIndices[paragraphIndices.length - 1] + 1}段`;
                                } else {
                                    rangeText = `第${paragraphIndices.map(idx => idx + 1).join('、')}段`;
                                }
                            }
                            passageTitle.textContent = `${selectedPassage.title}（${rangeText}）`;
                        }
                    }
                    
                    if (passageAuthor) {
                        passageAuthor.textContent = selectedPassage.author;
                    }
                    
                    // 停止秒表并重置
                    stopStopwatch();
                    if (timerElement) {
                        timerElement.textContent = "00:00.0";
                    }
                    // 確保恢復秒表時重新開始計時
                    elapsedTimeBeforePause = 0;
                    
                    // 更新進度顯示 - 使用選中段落的總字數
                    const totalCharsElement = document.getElementById('total-chars');
                    const progressTextElement = document.getElementById('progress-text');
                    const progressBarElement = document.getElementById('progress-bar');
                    
                    if (totalCharsElement) {
                        totalCharsElement.textContent = totalNonPunctChars;
                    }
                    
                    if (progressTextElement) {
                        progressTextElement.textContent = `0 / ${totalNonPunctChars}`;
                    }
                    
                    if (progressBarElement) {
                        progressBarElement.style.width = '0%';
                    }
                    
                    // 清空选项容器
                    const optionsContainer = document.getElementById('options-container');
                    if (optionsContainer) {
                        optionsContainer.innerHTML = '';
                        optionsContainer.className = 'grid grid-cols-3 gap-3 md:gap-4 mb-4';
                    }
                    
                    // 確保游戏开始界面準備好
                    if (gameContent) {
                        gameContent.classList.add('hidden');
                    }
                    
                    if (gameStartScreen) {
                        gameStartScreen.classList.remove('hidden');
                    }
                    
                    // 重置暫停狀態
                    isPaused = false;
                    hasPaused = false; // 重置是否使用過暫停的標記
                    
                    // 顯示遊戲頁面
                    gamePage.classList.remove('hidden');
                    
                    console.log("段落加載完成，遊戲準備就緒");
                    
                } catch (error) {
                    console.error("加載段落時發生錯誤:", error);
                }
            }
            
            let currentPosition = 0;
            let correctAnswers = 0;
            let canSelect = true;
            let lives = 3;
            
            const completedText = document.getElementById('completed-text');
            const currentChar = document.getElementById('current-char');
            const optionsContainer = document.getElementById('options-container');
            const feedback = document.getElementById('feedback');
            const helpBtn = document.getElementById('help-btn');
            const helpText = document.getElementById('help-text');
            
            // 秒表功能 - 修改為支持暫停/繼續
            function startStopwatch() {
                if (isPaused) return; // 如果遊戲已暫停，不啟動計時器
                
                // 設置開始時間 - 考慮先前累積的時間
                startTime = new Date();
                
                // 啟動計時器
                timerInterval = setInterval(updateStopwatch, 100);
            }
            
            function stopStopwatch() {
                // 如果計時器正在運行，停止並保存累計時間
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    
                    // 如果是暫停操作（而非遊戲結束等其他原因停止），更新累計時間
                    if (startTime && isPaused) {
                        const currentTime = new Date();
                        elapsedTimeBeforePause += (currentTime - startTime);
                        startTime = null; // 清除開始時間
                    }
                }
            }
            
            function resetStopwatch() {
                stopStopwatch();
                elapsedTimeBeforePause = 0; // 重置累計時間
                
                if (timerElement) {
                    timerElement.textContent = "00:00.0";
                }
                
                // 重新開始秒錶
                startStopwatch();
            }
            
            function updateStopwatch() {
                if (!timerElement || isPaused) return;
                
                const currentTime = new Date();
                // 計算總經過時間 = 之前累計的時間 + 當前計時段的時間
                const totalElapsedMs = elapsedTimeBeforePause + (currentTime - startTime);
                
                // 轉換為時間格式
                const totalElapsedDate = new Date(totalElapsedMs);
                const minutes = String(totalElapsedDate.getUTCMinutes()).padStart(2, '0');
                const seconds = String(totalElapsedDate.getUTCSeconds()).padStart(2, '0');
                const tenths = Math.floor(totalElapsedDate.getUTCMilliseconds() / 100);
                
                timerElement.textContent = `${minutes}:${seconds}.${tenths}`;
            }
            
            // 获取完成时间（以秒为单位）
            function getCompletionTimeInSeconds() {
                if (!timerElement) return 0;
                
                const timeString = timerElement.textContent;
                const parts = timeString.split(':');
                const minutePart = parseInt(parts[0]);
                const secondParts = parts[1].split('.');
                const secondPart = parseInt(secondParts[0]);
                const tenthPart = parseInt(secondParts[1]) / 10;
                
                // 返回总秒数（包括小数部分）
                return minutePart * 60 + secondPart + tenthPart;
            }
            
            // 初始显示，先不启动秒表
            if (timerElement) timerElement.textContent = "00:00.0";
            
            // 帮助按钮 - 添加自動滾動功能
            if (helpBtn && helpText) {
                helpBtn.addEventListener('click', function() {
                    helpText.classList.toggle('hidden');
                    
                    // 如果幫助文本顯示，滾動頁面使其完全可見
                    if (!helpText.classList.contains('hidden')) {
                        setTimeout(() => {
                            helpText.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 100);
                    }
                });
            }
            
            // 初始化暫停系統
            function initializePauseSystem() {
                const pauseBtn = document.getElementById('pause-btn');
                const pauseOverlay = document.getElementById('pause-overlay');
                const continueBtn = document.getElementById('continue-btn');
                const restartFromPauseBtn = document.getElementById('restart-from-pause-btn');
                const countdownResume = document.getElementById('countdown-resume');
                const pauseButtons = document.getElementById('pause-buttons');
                
                if (!pauseBtn || !pauseOverlay || !continueBtn || !restartFromPauseBtn || !countdownResume) {
                    console.error("暫停系統元素未找到");
                    return;
                }
                
                // 暫停按鈕點擊事件
                pauseBtn.addEventListener('click', function() {
                    // 只有在遊戲進行中且未暫停時才能暫停
                    if (gameStartScreen.classList.contains('hidden') && gameContent.classList.contains('hidden') === false && !isPaused) {
                        pauseGame();
                    }
                });
                
                // 繼續遊戲按鈕
                continueBtn.addEventListener('click', function() {
                    // 隱藏按鈕，顯示倒計時
                    pauseButtons.classList.add('hidden');
                    countdownResume.classList.remove('hidden');
                    
                    let count = 3;
                    const countdownNumber = countdownResume.querySelector('.pause-countdown-number');
                    countdownNumber.textContent = count;
                    
                    // 清除可能存在的倒計時
                    if (resumeCountdown) {
                        clearInterval(resumeCountdown);
                    }
                    
                    // 開始新的倒計時
                    resumeCountdown = setInterval(function() {
                        count--;
                        countdownNumber.textContent = count;
                        countdownNumber.style.animation = 'none';
                        void countdownNumber.offsetWidth; // 重置動畫
                        countdownNumber.style.animation = 'countdownPulse 1s ease-out';
                        
                        if (count <= 0) {
                            clearInterval(resumeCountdown);
                            resumeCountdown = null;
                            
                            // 恢復遊戲
                            resumeGame();
                            
                            // 重置界面
                            pauseButtons.classList.remove('hidden');
                            countdownResume.classList.add('hidden');
                        }
                    }, 1000);
                });
                
                // 重新開始按鈕
                restartFromPauseBtn.addEventListener('click', async function() {
                    // 先關閉暫停菜單
                    pauseOverlay.classList.add('hidden');
                    isPaused = false;
                    
                    // 清除倒計時
                    if (resumeCountdown) {
                        clearInterval(resumeCountdown);
                        resumeCountdown = null;
                    }
                    
                    // 重置界面
                    pauseButtons.classList.remove('hidden');
                    countdownResume.classList.add('hidden');
                    
                    // 執行重新開始
                    await restartGame();
                });
                
                // 鍵盤事件
                document.addEventListener('keydown', function(e) {
                    // 按下 ESC 鍵暫停/繼續
                    if (e.key === 'Escape') {
                        if (gameStartScreen.classList.contains('hidden') && gameContent.classList.contains('hidden') === false) {
                            if (isPaused) {
                                continueBtn.click();
                            } else {
                                pauseBtn.click();
                            }
                        }
                    }
                });
            }
            
            // 暫停遊戲
            function pauseGame() {
                if (isPaused) return; // 防止重複暫停
                
                isPaused = true;
                hasPaused = true; // 標記用戶使用了暫停功能
                
                // 暫停計時器 - 保存當前累計時間
                stopStopwatch();
                
                // 禁止選擇選項
                canSelect = false;
                
                // 顯示暫停覆蓋層
                const pauseOverlay = document.getElementById('pause-overlay');
                if (pauseOverlay) {
                    pauseOverlay.classList.remove('hidden');
                }
                
                console.log("遊戲已暫停");
            }
            
            // 恢復遊戲
            function resumeGame() {
                if (!isPaused) return; // 防止非暫停狀態下恢復
                
                isPaused = false;
                
                // 隱藏暫停覆蓋層
                const pauseOverlay = document.getElementById('pause-overlay');
                if (pauseOverlay) {
                    pauseOverlay.classList.add('hidden');
                }
                
                // 恢復計時器 - 從之前的累計時間繼續
                startStopwatch();
                
                // 允許選擇選項
                canSelect = true;
                
                console.log("遊戲已恢復，累計時間: " + elapsedTimeBeforePause + "ms");
            }
            
            // 重新開始遊戲
            async function restartGame() {
                // 先顯示載入動畫
                await showLoadingAnimation();
                
                // 重置遊戲狀態
                currentPosition = 0;
                correctAnswers = 0;
                wrongAnswersCount = 0;
                lives = 3;
                successfulChars = 0;
                lastAnsweredChars = [];
                
                // 重置UI元素
                const lastAnsweredCharsElem = document.getElementById('last-answered-chars');
                if (lastAnsweredCharsElem) {
                    lastAnsweredCharsElem.textContent = '';
                }
                
                updateLives();
                
                if (completedText) {
                    completedText.textContent = '';
                }
                
                if (feedback) {
                    feedback.textContent = '';
                    feedback.className = 'mt-4 text-center h-6 text-lg';
                }
                
                // 更新進度條
                const progressText = document.getElementById('progress-text');
                const progressBar = document.getElementById('progress-bar');
                
                if (progressText) {
                    progressText.textContent = `0 / ${totalNonPunctChars}`;
                }
                
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                
                // 重置遊戲狀態
                canSelect = true;
                isPaused = false;
                hasPaused = false; // 重置暫停標記
                
                // 重置秒表
                stopStopwatch();
                elapsedTimeBeforePause = 0; // 重置累計時間
                if (timerElement) {
                    timerElement.textContent = "00:00.0";
                }
                
                // 顯示開始屏幕
                if (gameContent && gameStartScreen) {
                    gameContent.classList.add('hidden');
                    gameStartScreen.classList.remove('hidden');
                }
                
                // 清空選項並恢復原始的網格佈局
                if (optionsContainer) {
                    optionsContainer.innerHTML = '';
                    optionsContainer.className = 'grid grid-cols-3 gap-3 md:gap-4 mb-4';
                }
                
                // 確保選擇篇章界面關閉
                if (passageContent && passageToggle && passageContainer) {
                    passageContent.classList.add('hidden');
                    passageToggle.style.transform = 'rotate(0deg)';
                    passageContainer.style.maxHeight = '46px';
                }
                
                console.log("遊戲已重新開始");
            }
            
            // 創建查看完整文章功能
            const viewFullTextBtn = document.getElementById('view-full-text-btn');
            if (viewFullTextBtn) {
                viewFullTextBtn.addEventListener('click', function() {
                    if (!currentPassageKey) {
                        alert('請先選擇一篇文章');
                        return;
                    }
                    
                    // 獲取當前文章完整內容
                    const passage = passages[currentPassageKey];
                    if (!passage) return;
                    
                    // 將段落轉換為HTML格式，使用網格佈局顯示段落編號和內容
                    const formattedParagraphs = passage.paragraphs.map((paragraph, index) => {
                        return `
                        <div class="grid grid-cols-[auto,1px,1fr] gap-3 mb-5">
                            <div class="text-amber-700 dark:text-amber-400 font-medium whitespace-nowrap py-1">第${index + 1}段</div>
                            <div class="bg-gray-300 dark:bg-gray-600 w-px"></div>
                            <div class="text-gray-700 dark:text-gray-300 py-1 text-lg">${paragraph}</div>
                        </div>`;
                    }).join('');
                    
                    // 創建模態框內容
                    fullTextModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">${passage.title}</h3>
                            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">${passage.author}</p>
                        <div class="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg">
                            ${formattedParagraphs}
                        </div>
                    </div>
                    `;
                    
                    // 顯示模態框
                    fullTextModal.classList.remove('hidden');
                    
                    // 關閉按鈕事件
                    document.getElementById('close-modal-btn').addEventListener('click', function() {
                        fullTextModal.classList.add('hidden');
                    });
                    
                    // 點擊背景關閉模態框
                    fullTextModal.addEventListener('click', function(e) {
                        if (e.target === fullTextModal) {
                            fullTextModal.classList.add('hidden');
                        }
                    });
                });
            }
            
            // 獲取並存儲進度相關的DOM元素
            const progressTextElement = document.getElementById('progress-text');
            const totalCharsElement = document.getElementById('total-chars');
            const progressBarElement = document.getElementById('progress-bar');
            
            function updateDisplay() {
                // 檢查當前位置字符是否是標點，如果是則跳過
                while (currentPosition < content.length && isPunctuation(content[currentPosition])) {
                    currentPosition++;
                }
                
                // 確保當前字符元素存在
                if (!currentChar) {
                    console.error('currentChar element is missing');
                    return;
                }
                
                // 更新當前字符顯示
                if (currentPosition < content.length) {
                    currentChar.textContent = content[currentPosition];
                    
                    // 檢查下一個字是否是標點，如果是則跳過
                    if (currentPosition + 1 < content.length) {
                        let nextPos = currentPosition + 1;
                        while (nextPos < content.length && isPunctuation(content[nextPos])) {
                            nextPos++;
                        }
                        
                        if (nextPos < content.length) {
                            generateOptions(nextPos);
                        } else {
                            // 完成所有字符
                            completePassage();
                        }
                    } else {
                        // 完成所有字符
                        completePassage();
                    }
                } else {
                    // 完成所有字符
                    completePassage();
                }
                
                // 計算並顯示非標點字符的進度
                let nonPunctChars = 0;
                for (let i = 0; i < currentPosition; i++) {
                    if (!isPunctuation(content[i])) {
                        nonPunctChars++;
                    }
                }
                
                // 確保進度條相關元素存在
                try {
                    // 更新進度條 - 使用選中段落的總字數
                    if (totalCharsElement) totalCharsElement.textContent = totalNonPunctChars;
                    if (progressTextElement) progressTextElement.textContent = `${nonPunctChars} / ${totalNonPunctChars}`;
                    const progressPercentage = (totalNonPunctChars > 0) ? (nonPunctChars / totalNonPunctChars * 100) : 0;
                    if (progressBarElement) progressBarElement.style.width = `${progressPercentage}%`;
                } catch (e) {
                    console.error('Error updating progress UI:', e);
                }
            }
            
            function generateOptions(nextPos) {
                if (!optionsContainer) {
                    console.error("選項容器元素未找到");
                    return;
                }
                
                // 确保 nextPos 不是标点符号
                while (nextPos < content.length && isPunctuation(content[nextPos])) {
                    nextPos++;
                }
                
                // 清空选项容器
                optionsContainer.innerHTML = '';
                
                // 正确答案
                const correctAnswer = content[nextPos];
                
                // 生成两个干扰选项
                let options = [correctAnswer];
                
                while (options.length < 3) {
                    const randomIndex = Math.floor(Math.random() * content.length);
                    const randomChar = content[randomIndex];
                    
                    // 确保不重复且不是标点符号
                    if (!options.includes(randomChar) && 
                        !isPunctuation(randomChar) && 
                        randomChar !== correctAnswer) {
                        options.push(randomChar);
                    }
                }
                
                // 打乱选项顺序
                options = shuffleArray(options);
                
                // 创建选项按钮
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn h-16 md:h-20 text-2xl md:text-3xl bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none';
                    btn.textContent = option;
                    
                    btn.addEventListener('click', function() {
                        if (!canSelect || isPaused) return; // 如果已暫停，不允許選擇
                        
                        if (option === correctAnswer) {
                            // 只在正確答案時創建墨滴效果
                            createInkDrop(btn);
                            handleCorrectAnswer(btn);
                        } else {
                            // 錯誤時不創建墨滴
                            handleIncorrectAnswer(btn);
                        }
                    });
                    
                    optionsContainer.appendChild(btn);
                });
            }
            
            function handleCorrectAnswer(btn) {
                canSelect = false;
                correctAnswers++;
                
                // 添加正确效果
                btn.classList.add('correct');
                
                // 更新反馈
                if (feedback) {
                    feedback.textContent = '正確！';
                    feedback.className = 'mt-4 text-center h-6 text-lg text-green-600 dark:text-green-400';
                }
                
                // 添加当前字符到已回答的字符列表
                lastAnsweredChars.push(content[currentPosition]);
                
                // 保存当前位置
                const savedPosition = currentPosition;
                
                // 检查并添加后续标点符号
                currentPosition++;
                while (currentPosition < content.length && isPunctuation(content[currentPosition])) {
                    // 将标点符号也添加到已回答列表
                    lastAnsweredChars.push(content[currentPosition]);
                    currentPosition++;
                }
                
                // 如果超出最大显示字数限制，移除最早的字符
                while (lastAnsweredChars.length > MAX_DISPLAYED_CHARS) {
                    lastAnsweredChars.shift();
                }
                
                // 更新已回答字符显示
                const lastAnsweredCharsElem = document.getElementById('last-answered-chars');
                if (lastAnsweredCharsElem) {
                    lastAnsweredCharsElem.textContent = lastAnsweredChars.join('');
                }
                
                // 增加成功背誦字數計數
                if (!isPunctuation(content[savedPosition])) {
                    successfulChars++;
                    
                    // 每成功背誦50字，恢復1點生命值（上限為3點）
                    if (successfulChars % 50 === 0 && lives < 3) {
                        lives++;
                        updateLives();
                        
                        // 顯示恢復生命值動畫效果
                        const healEffect = document.createElement('div');
                        healEffect.className = 'fixed inset-0 pointer-events-none z-50 flex items-center justify-center';
                        healEffect.innerHTML = `<div class="bg-green-500 bg-opacity-30 p-4 rounded-full text-white text-2xl font-bold animate-pulse">+1 ❤️</div>`;
                        document.body.appendChild(healEffect);
                        
                        setTimeout(() => {
                            healEffect.remove();
                        }, 1500);
                    }
                }
                
                updateDisplay();
                canSelect = true;
            }
            
            function handleIncorrectAnswer(btn) {
                // 添加错误效果
                btn.classList.add('incorrect');
                
                // 扣除生命值
                lives--;
                updateLives();
                
                // 增加錯誤計數
                wrongAnswersCount++;
                
                // 检查游戏是否结束
                if (lives <= 0) {
                    gameOver();
                    return;
                }
                
                // 更新反馈
                if (feedback) {
                    feedback.textContent = '嘗試另一個選項';
                    feedback.className = 'mt-4 text-center h-6 text-lg text-red-600 dark:text-red-400';
                }
                
                // 添加屏幕震动效果
                document.body.classList.add('screen-shake');
                setTimeout(() => {
                    document.body.classList.remove('screen-shake');
                }, 500);
                
                // 延迟移除效果
                setTimeout(() => {
                    btn.classList.remove('incorrect');
                    if (feedback) {
                        feedback.textContent = '';
                    }
                }, 1000);
            }
            
            function updateLives() {
                const livesContainer = document.getElementById('lives');
                if (!livesContainer) return;
                
                livesContainer.innerHTML = '';
                
                for (let i = 0; i < lives; i++) {
                    const heart = document.createElement('i');
                    heart.className = 'fas fa-heart mx-0.5 animate-pulse';
                    livesContainer.appendChild(heart);
                }
                
                for (let i = 0; i < 3 - lives; i++) {
                    const emptyHeart = document.createElement('i');
                    emptyHeart.className = 'far fa-heart mx-0.5 text-gray-400 dark:text-gray-600';
                    livesContainer.appendChild(emptyHeart);
                }
            }
            
            function gameOver() {
                canSelect = false;
                stopStopwatch();
                
                // 显示游戏结束屏幕
                if (gameContent) {
                    gameContent.classList.add('hidden');
                }
                
                // 檢查是否過半後失敗並更新成就
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    const progressWidth = progressBar.style.width || '0%';
                    const progressPercent = parseFloat(progressWidth);
                    
                    // 如果進度超過50%，記錄為過半後失敗
                    if (progressPercent >= 50) {
                        // 增加失敗計數
                        globalStats.failAfterHalfwayCount = (globalStats.failAfterHalfwayCount || 0) + 1;
                        
                        // 更新挫敗之路成就等級
                        const failCount = globalStats.failAfterHalfwayCount;
                        
                        if (failCount >= 200 && globalStats.achievements.defeatLevel < 5) {
                            globalStats.achievements.defeatLevel = 5; // 心如止水 (200次)
                        } else if (failCount >= 100 && globalStats.achievements.defeatLevel < 4) {
                            globalStats.achievements.defeatLevel = 4; // 小強是我 (100次)
                        } else if (failCount >= 50 && globalStats.achievements.defeatLevel < 3) {
                            globalStats.achievements.defeatLevel = 3; // 鋼鐵意志 (50次)
                        } else if (failCount >= 10 && globalStats.achievements.defeatLevel < 2) {
                            globalStats.achievements.defeatLevel = 2; // 堅毅 (10次)
                        } else if (failCount >= 1 && globalStats.achievements.defeatLevel < 1) {
                            globalStats.achievements.defeatLevel = 1; // 初嘗敗績 (1次)
                        }
                        
                        console.log(`過半後失敗，總計: ${failCount}次，成就等級: ${globalStats.achievements.defeatLevel}`);
                        
                        // 保存更新的統計數據
                        saveStats();
                    }
                }
                
                // 清空选项容器并修改布局为flex布局
                if (!optionsContainer) {
                    console.error("選項容器未找到，無法顯示遊戲結束界面");
                    return;
                }
                
                optionsContainer.innerHTML = '';
                optionsContainer.className = 'flex justify-center items-center mb-4';
                
                const gameOverMessage = document.createElement('div');
                gameOverMessage.className = 'text-center bg-white dark:bg-gray-700 p-6 rounded-lg shadow-md w-4/5';
                gameOverMessage.innerHTML = `
                    <p class="text-2xl text-red-600 dark:text-red-500 mb-6 font-bold">可惜！</p>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg mb-5">
                        <p class="text-gray-700 dark:text-gray-300">時間: ${timerElement ? timerElement.textContent : "00:00.0"}</p>
                        <p class="text-gray-700 dark:text-gray-300">錯誤次數: ${wrongAnswersCount}</p>
                    </div>
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="return-start-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90">
                            返回
                        </button>
                    </div>
                `;
                
                optionsContainer.appendChild(gameOverMessage);
                
                // 震動效果
                document.body.classList.add('game-over-shake');
                setTimeout(() => {
                    document.body.classList.remove('game-over-shake');
                }, 1000);
                
                // 添加返回按鈕的事件監聽
                setTimeout(() => {
                    const returnStartBtn = document.getElementById('return-start-btn');
                    if (returnStartBtn) {
                        returnStartBtn.addEventListener('click', function() {
                            // 重置遊戲狀態
                            currentPosition = 0;
                            correctAnswers = 0;
                            lives = 3;
                            successfulChars = 0; // 重置成功背誦計數器
                            wrongAnswersCount = 0; // 重置錯誤計數器
                            lastAnsweredChars = []; // 清空已回答列表
                            
                            const lastAnsweredCharsElem = document.getElementById('last-answered-chars');
                            if (lastAnsweredCharsElem) {
                                lastAnsweredCharsElem.textContent = '';
                            }
                            
                            canSelect = true; // 確保可以選擇選項
                            isPaused = false; // 確保遊戲不是暫停狀態
                            hasPaused = false; // 重置暫停標記
                            updateLives();
                            
                            if (feedback) {
                                feedback.textContent = '';
                            }
                            
                            // 更新進度條
                            const progressText = document.getElementById('progress-text');
                            const progressBar = document.getElementById('progress-bar');
                            
                            if (progressText) {
                                progressText.textContent = `0 / ${totalNonPunctChars}`;
                            }
                            
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                            
                            // 显示开始屏幕
                            if (gameContent && gameStartScreen) {
                                gameContent.classList.add('hidden');
                                gameStartScreen.classList.remove('hidden');
                            }
                            
                            // 清空选项并恢复原始的网格布局
                            if (optionsContainer) {
                                optionsContainer.innerHTML = '';
                                optionsContainer.className = 'grid grid-cols-3 gap-3 md:gap-4 mb-4';
                            }
                        });
                    }
                }, 100);
            }
            
            // 顯示墨水擴散載入動畫
            function showLoadingAnimation() {
                // 先隱藏所有頁面元素
                document.querySelectorAll('.container > *').forEach(el => {
                    if (el.style) {
                        el.style.visibility = 'hidden';
                    }
                });
                
                // 創建僅包含中央墨點的動畫容器
                const loadingContainer = document.createElement('div');
                loadingContainer.id = 'loading-container';
                loadingContainer.innerHTML = `
                    <div id="main-splash"></div>
                `;
                document.body.appendChild(loadingContainer);
                
                // 減少等待時間至0.9秒
                return new Promise(resolve => {
                    setTimeout(function() {
                        hideLoadingAnimation();
                        
                        // 顯示頁面元素
                        document.querySelectorAll('.container > *').forEach(el => {
                            if (el.style) {
                                el.style.visibility = 'visible';
                            }
                        });
                        
                        resolve();
                    }, 900);
                });
            }
            
            function hideLoadingAnimation() {
                const container = document.getElementById('loading-container');
                if (container) {
                    container.classList.add('fade-out');
                    // 加快淡出時間
                    setTimeout(function() {
                        container.remove();
                    }, 200);
                }
            }
            
            // 創建紙屑慶祝效果
            function createConfetti() {
                // 加載 canvas-confetti 庫
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
                document.head.appendChild(script);
                
                // 建立 canvas 元素
                const canvas = document.createElement('canvas');
                canvas.id = 'confetti-canvas';
                document.body.appendChild(canvas);
                
                script.onload = function() {
                    // 設置 confetti
                    const myConfetti = confetti.create(canvas, {
                        resize: true,
                        useWorker: true
                    });
                    
                    // 開始紙屑效果
                    
                    // 第一波：從頂部射出
                    myConfetti({
                        particleCount: 180,
                        spread: 100,
                        origin: { y: 0 },
                        colors: ['#5D5CDE', '#FF8C00', '#4CAF50', '#FF5252', '#FFC107', '#2196F3'],
                        startVelocity: 30,
                        gravity: 0.7,
                        scalar: 0.9
                    });
                    
                    // 從左右兩側射出
                    setTimeout(() => {
                        // 左側紙屑
                        myConfetti({
                            particleCount: 100,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0, y: 0.5 },
                            colors: ['#5D5CDE', '#4CAF50', '#FFC107', '#2196F3']
                        });
                        
                        // 右側紙屑
                        myConfetti({
                            particleCount: 100,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1, y: 0.5 },
                            colors: ['#FF8C00', '#FF5252', '#E91E63', '#9C27B0']
                        });
                    }, 700);
                    
                    // 第二波紙屑 - 從底部向上射出
                    setTimeout(() => {
                        myConfetti({
                            particleCount: 120,
                            spread: 120,
                            origin: { y: 0.9 },
                            startVelocity: 45,
                            gravity: 1,
                            scalar: 0.7
                        });
                    }, 1500);
                    
                    // 第三波 - 爆炸效果
                    setTimeout(() => {
                        myConfetti({
                            particleCount: 150,
                            spread: 180,
                            origin: { x: 0.5, y: 0.5 }
                        });
                    }, 2500);
                    
                    // 清理資源
                    setTimeout(() => {
                        canvas.remove();
                    }, 8000);
                };
            }
            
            function completePassage() {
                // 停止遊戲内容顯示
                if (gameContent) {
                    gameContent.classList.add('hidden');
                }
                
                // 如果指定的DOM元素不存在，則記錄錯誤並中止
                if (!optionsContainer) {
                    console.error("optionsContainer未找到，無法顯示遊戲完成界面");
                    return;
                }
                
                // 清空当前字符显示
                if (currentChar) {
                    currentChar.textContent = '';
                }
                
                // 停止秒錶
                stopStopwatch();
                const finalTime = timerElement ? timerElement.textContent : "00:00.0";
                
                // 計算總完成時間（秒）
                const totalSeconds = getCompletionTimeInSeconds();
                
                // 記錄通關成績 - 檢查是否為完整篇章
                const selectedPassage = passages[currentPassageKey];
                if (selectedPassage) {
                    // 確保用於檢查完整篇章時顯示正確的結果
                    let allParagraphsContent = selectedPassage.paragraphs.join('');
                    const isFullPassage = (content === allParagraphsContent);
                    
                    console.log("完成挑戰");
                    console.log("篇章鍵值:", currentPassageKey);
                    console.log("是否為完整篇章:", isFullPassage);
                    console.log("完成時間(秒):", totalSeconds);
                    
                    // 只有完整篇章才記錄成績
                    recordCompletionStats(currentPassageKey, totalSeconds, isFullPassage);
                }
                
                // 播放紙屑慶祝效果
                createConfetti();
                
                // 判斷成就
                const isPerfect = wrongAnswersCount === 0;
                const isLightningFast = totalSeconds <= totalNonPunctChars * 0.8; // 使用总字数*0.8秒作为閃電俠阈值
                const isMaster = totalNonPunctChars >= 300; // 記憶大師（字數超過300）
                const isSnail = totalSeconds >= totalNonPunctChars * 3; // 蝸牛（時間超過字數*3秒）
                const isTireless = !hasPaused; // 不知疲倦（全程不暫停）
                
                // 更新極速之路和完美之路成就
                if (isLightningFast) {
                    // 增加獲得閃電俠成就次數
                    globalStats.lightningAchievementCount = (globalStats.lightningAchievementCount || 0) + 1;
                    
                    // 更新極速之路成就等級
                    const lightningCount = globalStats.lightningAchievementCount;
                    
                    if (lightningCount >= 100 && globalStats.achievements.speedRouteLevel < 4) {
                        globalStats.achievements.speedRouteLevel = 4; // 世界第一束光 (100次)
                    } else if (lightningCount >= 50 && globalStats.achievements.speedRouteLevel < 3) {
                        globalStats.achievements.speedRouteLevel = 3; // 無影手 (50次)
                    } else if (lightningCount >= 10 && globalStats.achievements.speedRouteLevel < 2) {
                        globalStats.achievements.speedRouteLevel = 2; // 肌肉記憶 (10次)
                    } else if (lightningCount >= 1 && globalStats.achievements.speedRouteLevel < 1) {
                        globalStats.achievements.speedRouteLevel = 1; // 敏捷 (1次)
                    }
                    
                    console.log(`獲得閃電俠成就，總計: ${lightningCount}次，極速之路等級: ${globalStats.achievements.speedRouteLevel}`);
                }
                
                if (isPerfect) {
                    // 增加獲得完美無瑕成就次數
                    globalStats.perfectAchievementCount = (globalStats.perfectAchievementCount || 0) + 1;
                    
                    // 更新完美之路成就等級
                    const perfectCount = globalStats.perfectAchievementCount;
                    
                    if (perfectCount >= 100 && globalStats.achievements.perfectRouteLevel < 4) {
                        globalStats.achievements.perfectRouteLevel = 4; // 至善 (100次)
                    } else if (perfectCount >= 50 && globalStats.achievements.perfectRouteLevel < 3) {
                        globalStats.achievements.perfectRouteLevel = 3; // 滿月 (50次)
                    } else if (perfectCount >= 10 && globalStats.achievements.perfectRouteLevel < 2) {
                        globalStats.achievements.perfectRouteLevel = 2; // 完美主義 (10次)
                    } else if (perfectCount >= 1 && globalStats.achievements.perfectRouteLevel < 1) {
                        globalStats.achievements.perfectRouteLevel = 1; // 如沐春風 (1次)
                    }
                    
                    console.log(`獲得完美無瑕成就，總計: ${perfectCount}次，完美之路等級: ${globalStats.achievements.perfectRouteLevel}`);
                }
                
                // 創建成就徽章
                const createSealSVG = (colors, borderColor) => {
                    // 確保每個SVG有唯一ID
                    const uniqueId = 'seal_' + Math.random().toString(36).substr(2, 9);
                    return `
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <radialGradient id="${uniqueId}" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                <stop offset="0%" style="stop-color:${colors.center}" />
                                <stop offset="70%" style="stop-color:${colors.middle}" />
                                <stop offset="100%" style="stop-color:${colors.outer}" />
                            </radialGradient>
                        </defs>
                        <circle cx="50" cy="50" r="45" fill="url(#${uniqueId})" />
                        <circle cx="50" cy="50" r="42" fill="none" stroke="${borderColor}" stroke-width="1" stroke-dasharray="2,1" />
                        <circle cx="50" cy="50" r="38" fill="none" stroke="${borderColor}" stroke-width="0.5" />
                    </svg>
                    `;
                };
                
                // 定義各成就蠟章顏色
                const perfectColors = { center: '#8B0000', middle: '#5C0000', outer: '#400000' };
                const lightningColors = { center: '#4B0082', middle: '#2A004D', outer: '#1C0033' };
                const masterColors = { center: '#006400', middle: '#004D00', outer: '#003300' };
                const snailColors = { center: '#8B4513', middle: '#6B3100', outer: '#4A2100' };
                const tirelessColors = { center: '#1E3A8A', middle: '#1E40AF', outer: '#1D4ED8' }; // 藍色調代表專注和堅持
                
                // 格式化成就信息
                const achievements = [];
                
                if (isPerfect) {
                    achievements.push({
                        svg: createSealSVG(perfectColors, '#FFD700'),
                        title: '完美無瑕',
                        desc: '零錯誤通關'
                    });
                }
                
                if (isLightningFast) {
                    achievements.push({
                        svg: createSealSVG(lightningColors, '#00FFFF'),
                        title: '閃電俠',
                        desc: '神速完成'
                    });
                }
                
                if (isMaster) {
                    // 增加獲得記憶大師成就次數
                    globalStats.memoryAchievementCount = (globalStats.memoryAchievementCount || 0) + 1;
                    
                    // 更新記憶之路成就等級
                    const memoryCount = globalStats.memoryAchievementCount;
                    
                    if (memoryCount >= 80 && globalStats.achievements.memoryRouteLevel < 4) {
                        globalStats.achievements.memoryRouteLevel = 4; // 流如背倒 (80次)
                    } else if (memoryCount >= 50 && globalStats.achievements.memoryRouteLevel < 3) {
                        globalStats.achievements.memoryRouteLevel = 3; // 移動圖書館 (50次)
                    } else if (memoryCount >= 20 && globalStats.achievements.memoryRouteLevel < 2) {
                        globalStats.achievements.memoryRouteLevel = 2; // 記憶麵包 (20次)
                    } else if (memoryCount >= 1 && globalStats.achievements.memoryRouteLevel < 1) {
                        globalStats.achievements.memoryRouteLevel = 1; // 激活腦細胞 (1次)
                    }
                    
                    console.log(`獲得記憶大師成就，總計: ${memoryCount}次，記憶之路等級: ${globalStats.achievements.memoryRouteLevel}`);
                    
                    achievements.push({
                        svg: createSealSVG(masterColors, '#7CFC00'),
                        title: '記憶大師',
                        desc: '精通300字以上'
                    });
                }
                
                if (isSnail) {
                    achievements.push({
                        svg: createSealSVG(snailColors, '#DAA520'),
                        title: '蝸牛',
                        desc: '慢工出細活'
                    });
                }
                
                // 添加新成就：不知疲倦，並更新相關計數
                if (isTireless) {
                    // 增加獲得不知疲倦成就次數
                    globalStats.tirelessAchievementCount = (globalStats.tirelessAchievementCount || 0) + 1;
                    
                    // 檢查是否達成「眼乾」成就（獲得不知疲倦30次）
                    if (globalStats.tirelessAchievementCount >= 30 && !globalStats.achievements.dryEyes) {
                        globalStats.achievements.dryEyes = true;
                        console.log("獲得獨立成就：眼乾（獲得不知疲倦30次）");
                    }
                    
                    achievements.push({
                        svg: createSealSVG(tirelessColors, '#38BDF8'),
                        title: '不知疲倦',
                        desc: '全程不暫停'
                    });
                }
                
                // 保存更新的統計和成就
                saveStats();
                
                // 清空選項容器並修改布局為flex布局
                optionsContainer.innerHTML = '';
                optionsContainer.className = 'flex flex-col justify-center items-center mb-4';
                
                const completionMessage = document.createElement('div');
                completionMessage.className = 'text-center bg-white dark:bg-gray-700 p-6 rounded-lg shadow-md w-full sm:w-4/5';
                
                // 生成成就徽章HTML
                let achievementsHTML = '';
                if (achievements.length > 0) {
                    achievementsHTML = `
                    <div class="mb-5 mt-4">
                        <p class="text-lg font-medium text-amber-700 dark:text-amber-400 mb-3">獲得成就:</p>
                        <div class="achievements-container">
                    `;
                    
                    // 添加每個成就徽章
                    achievements.forEach(achievement => {
                        achievementsHTML += `
                        <div class="achievement-seal">
                            ${achievement.svg}
                            <div class="seal-text">
                                <span class="seal-title">${achievement.title}</span>
                                <span class="seal-desc">${achievement.desc}</span>
                            </div>
                        </div>`;
                    });
                    
                    achievementsHTML += `</div></div>`;
                }
                
                // 生成完整信息HTML
                completionMessage.innerHTML = `
                    <p class="text-2xl text-green-600 dark:text-green-400 mb-6 font-bold">恭喜完成！</p>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg mb-4">
                        <p class="text-gray-700 dark:text-gray-300">完成時間: ${finalTime}</p>
                        <p class="text-gray-700 dark:text-gray-300">錯誤次數: ${wrongAnswersCount}</p>
                        <p class="text-gray-700 dark:text-gray-300">總字數: ${totalNonPunctChars}</p>
                    </div>
                    ${achievementsHTML}
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="completion-return-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90">
                            返回
                        </button>
                    </div>
                `;
                
                optionsContainer.appendChild(completionMessage);
                
                // 添加返回按鈕的事件監聽
                setTimeout(() => {
                    const completionReturnBtn = document.getElementById('completion-return-btn');
                    if (completionReturnBtn) {
                        completionReturnBtn.addEventListener('click', function() {
                            // 重置游戏状态
                            currentPosition = 0;
                            correctAnswers = 0;
                            lives = 3;
                            successfulChars = 0; // 重置成功背誦計數器
                            wrongAnswersCount = 0; // 重置錯誤計數器
                            lastAnsweredChars = []; // 清空已回答列表
                            
                            const lastAnsweredCharsElem = document.getElementById('last-answered-chars');
                            if (lastAnsweredCharsElem) {
                                lastAnsweredCharsElem.textContent = '';
                            }
                            
                            canSelect = true; // 確保可以選擇選項
                            isPaused = false; // 確保遊戲不是暫停狀態
                            hasPaused = false; // 重置暫停標記
                            elapsedTimeBeforePause = 0; // 重置累計時間
                            updateLives();
                            
                            if (feedback) {
                                feedback.textContent = '';
                            }
                            
                            // 更新進度條
                            const progressText = document.getElementById('progress-text');
                            const progressBar = document.getElementById('progress-bar');
                            
                            if (progressText) {
                                progressText.textContent = `0 / ${totalNonPunctChars}`;
                            }
                            
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                            
                            // 显示开始屏幕
                            if (gameContent && gameStartScreen) {
                                gameContent.classList.add('hidden');
                                gameStartScreen.classList.remove('hidden');
                            }
                            
                            // 清空选项并恢复原始的网格布局
                            if (optionsContainer) {
                                optionsContainer.innerHTML = '';
                                optionsContainer.className = 'grid grid-cols-3 gap-3 md:gap-4 mb-4';
                            }
                        });
                    }
                }, 100);
            }
            
            // 创建墨滴效果
            function createInkDrop(element) {
                if (!element) return;
                
                const inkDrop = document.createElement('div');
                inkDrop.className = 'ink-drop';
                
                // 计算点击位置
                const rect = element.getBoundingClientRect();
                const x = Math.random() * (rect.width - 10);
                const y = Math.random() * (rect.height - 10);
                
                inkDrop.style.left = `${x}px`;
                inkDrop.style.top = `${y}px`;
                
                element.style.position = 'relative';
                element.style.overflow = 'hidden';
                element.appendChild(inkDrop);
                
                // 移除元素
                setTimeout(() => {
                    if (inkDrop.parentNode === element) {
                        inkDrop.remove();
                    }
                }, 2000);
            }
            
            // 辅助函数
            function isPunctuation(char) {
                // 檢查所有可能的冒號變體和其他標點
                if (!char) return false;
                
                const charCode = char.charCodeAt(0);
                // 全形冒號(U+FF1A)和半形冒號(U+003A)
                if (charCode === 0xFF1A || charCode === 0x003A) {
                    return true;
                }
                // 檢查其他標點符號
                return '「」：︰！，。；----……『』、？:'.includes(char);
            }
            
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            // 初始化設置按鈕及相關功能
            initializeSettings();
            
            // 初始化本地存儲功能 - 用於記錄用戶成績
            initializeLocalStorage();
            
            // 設置功能初始化
            function initializeSettings() {
                const settingsButton = document.getElementById('settings-button');
                const settingsMenu = document.getElementById('settings-menu');
                const closeSettings = document.getElementById('close-settings');
                const settingsOptions = document.querySelectorAll('.settings-option');
                const infoModal = document.getElementById('info-modal');
                const closeInfoModal = document.getElementById('close-info-modal');
                const infoModalTitle = document.getElementById('info-modal-title');
                const infoModalContent = document.getElementById('info-modal-content');
                
                if (!settingsButton || !settingsMenu || !closeSettings || !infoModal || !closeInfoModal || !infoModalTitle || !infoModalContent) {
                    console.error('設置相關元素未找到');
                    return;
                }
                
                // 添加設置按鈕狀態控制功能
                function disableSettingsButton() {
                    settingsButton.classList.add('disabled');
                    settingsButton.style.opacity = '0.5';
                    settingsButton.style.cursor = 'not-allowed';
                    settingsButton.style.pointerEvents = 'none'; // 阻止所有點擊
                }
                
                function enableSettingsButton() {
                    settingsButton.classList.remove('disabled');
                    settingsButton.style.opacity = '1';
                    settingsButton.style.cursor = 'pointer';
                    settingsButton.style.pointerEvents = 'auto';
                }
                
                // 打開設置菜單
                settingsButton.addEventListener('click', function() {
                    settingsMenu.classList.remove('hidden');
                    // 禁用設置按鈕直到關閉菜單
                    disableSettingsButton();
                });
                
                // 關閉設置菜單並重新啟用設置按鈕
                closeSettings.addEventListener('click', function() {
                    settingsMenu.classList.add('hidden');
                    enableSettingsButton();
                });
                
                // 點擊背景關閉設置菜單並重新啟用設置按鈕
                settingsMenu.addEventListener('click', function(e) {
                    if (e.target === settingsMenu) {
                        settingsMenu.classList.add('hidden');
                        enableSettingsButton();
                    }
                });
                
                // 關閉信息模態框時重新啟用設置按鈕
                closeInfoModal.addEventListener('click', function() {
                    infoModal.classList.add('hidden');
                    enableSettingsButton();
                });
                
                // 點擊背景關閉信息模態框時重新啟用設置按鈕
                infoModal.addEventListener('click', function(e) {
                    if (e.target === infoModal) {
                        infoModal.classList.add('hidden');
                        enableSettingsButton();
                    }
                });
                
                // 設置選項點擊事件 - 修正版本，附帶調試輸出
                settingsOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const section = this.dataset.section;
                        console.log(`點擊了設置選項: ${section}`);
                        
                        try {
                            // 關閉設置菜單
                            settingsMenu.classList.add('hidden');
                            
                            // 確保模態框元素及其內容區域可用
                            if (!infoModal || !infoModalTitle || !infoModalContent) {
                                console.error("模態框元素未找到:", {
                                    infoModal: !!infoModal,
                                    infoModalTitle: !!infoModalTitle,
                                    infoModalContent: !!infoModalContent
                                });
                                alert("系統錯誤：無法顯示信息視窗");
                                return;
                            }
                            
                            // 根據選項顯示不同內容
                            if (section === 'help') {
                                // 遊玩說明 - 顯示遊玩說明內容
                                infoModalTitle.textContent = '遊玩說明';
                                infoModalContent.innerHTML = `
                                    <div class="space-y-4">
                                        <p class="mb-2"><strong>遊玩說明:</strong></p>
                                        <ol class="list-decimal pl-5 space-y-1">
                                            <li>螢幕將顯示文章的當前字元；</li>
                                            <li>從三個選項中選擇正確的下一個字；</li>
                                            <li>初始擁有3點生命值，每次錯誤扣除1點；</li>
                                            <li>成功背誦每50個字元可恢復1點生命值（最多3點）；</li>
                                            <li>以最快的時間完成挑戰，爭取獲得成就！</li>
                                        </ol>
                                        <div class="mt-4 p-3 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
                                            <p class="text-amber-800 dark:text-amber-400 font-medium">成就系統：</p>
                                            <ul class="list-disc pl-5 mt-2 text-gray-700 dark:text-gray-300">
                                                <li><strong>完美無瑕</strong> - 無錯誤完成挑戰</li>
                                                <li><strong>閃電俠</strong> - 以超快速度完成挑戰</li>
                                                <li><strong>記憶大師</strong> - 成功背誦300字以上的長篇</li>
                                                <li><strong>蝸牛</strong> - 慢工出細活</li>
                                                <li><strong>不知疲倦</strong> - 全程未使用暫停功能</li>
                                            </ul>
                                        </div>
                                        <p class="mt-2">更多功能，敬請期待！</p>
                                    </div>
                                `;
                                infoModal.classList.remove('hidden');
                                console.log("已顯示遊玩說明");
                                
                            } else if (section === 'records') {
                                try {
                                    // 我的記錄 - 顯示用戶的記錄
                                    infoModalTitle.textContent = '我的記錄';
                                    
                                    // 檢查userRecordsMemory是否已初始化
                                    if (typeof userRecordsMemory !== 'object' || userRecordsMemory === null) {
                                        userRecordsMemory = {};
                                        console.log("在點擊處理函數中初始化userRecordsMemory");
                                    }
                                    
                                    // 檢查displayUserRecords函數是否存在
                                    if (typeof displayUserRecords !== 'function') {
                                        console.error("displayUserRecords函數未定義");
                                        infoModalContent.innerHTML = `
                                            <div class="text-center p-4">
                                                <i class="fas fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                                                <p class="text-gray-700 dark:text-gray-300">系統錯誤：無法顯示記錄功能</p>
                                            </div>
                                        `;
                                    } else {
                                        // 先顯示加載訊息
                                        infoModalContent.innerHTML = `
                                            <div class="text-center p-4">
                                                <i class="fas fa-spinner fa-spin text-amber-500 text-3xl mb-3"></i>
                                                <p class="text-gray-700 dark:text-gray-300">載入記錄中...</p>
                                            </div>
                                        `;
                                        
                                        // 確保模態框先顯示
                                        infoModal.classList.remove('hidden');
                                        
                                        // 使用setTimeout讓UI先更新，再調用顯示記錄函數
                                        setTimeout(() => {
                                            try {
                                                displayUserRecords();
                                                console.log("已顯示用戶記錄");
                                            } catch (err) {
                                                console.error("顯示記錄時發生錯誤:", err);
                                                infoModalContent.innerHTML = `
                                                    <div class="text-center p-4">
                                                        <i class="fas fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                                                        <p class="text-gray-700 dark:text-gray-300">載入記錄時發生錯誤</p>
                                                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">${err.message}</p>
                                                    </div>
                                                `;
                                            }
                                        }, 50);
                                    }
                                } catch (err) {
                                    console.error("處理記錄選項時發生錯誤:", err);
                                    infoModalContent.innerHTML = `
                                        <div class="text-center p-4">
                                            <i class="fas fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                                            <p class="text-gray-700 dark:text-gray-300">處理記錄時發生錯誤</p>
                                            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">${err.message}</p>
                                        </div>
                                    `;
                                    infoModal.classList.remove('hidden');
                                }
                                
                            } else if (section === 'version') {
                                // 版本資訊 - 顯示版本更新內容
                                infoModalTitle.textContent = '版本資訊';
                                infoModalContent.innerHTML = `
                                    <div class="space-y-4">
                                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                            <h4 class="text-lg font-medium text-primary mb-3">v1.3 更新資訊</h4>
                                            <ul class="list-disc pl-5 text-gray-700 dark:text-gray-300 space-y-2">
                                                <li>添加本地儲存功能，用戶資料和成就在不同會話間保留</li>
                                                <li>自動適應系統深色模式</li>
                                                <li>記錄功能改進：只在完成全文時才計入記錄</li>
                                                <li>界面優化與穩定性改進</li>
                                            </ul>
                                        </div>
                                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg opacity-90">
                                            <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-3">v1.2 更新資訊</h4>
                                            <ul class="list-disc pl-5 text-gray-600 dark:text-gray-400 space-y-1">
                                                <li>新增設置中心，包含遊玩說明、記錄查詢和版本資訊</li>
                                                <li>新增用戶記錄功能，可查看各篇章通關次數和最佳成績</li>
                                                <li>新增「不知疲倦」成就，獎勵全程不使用暫停功能的玩家</li>
                                                <li>優化遊戲介面，提升視覺效果和用戶體驗</li>
                                                <li>修復若干已知問題，提升遊戲穩定性</li>
                                            </ul>
                                        </div>
                                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg opacity-70">
                                            <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-3">v1.1 更新資訊</h4>
                                            <ul class="list-disc pl-5 text-gray-600 dark:text-gray-400 space-y-1">
                                                <li>新增暫停功能，允許玩家暫時中斷遊戲</li>
                                                <li>新增多種成就獎勵</li>
                                                <li>優化選擇篇章界面</li>
                                                <li>新增生命恢復機制</li>
                                            </ul>
                                        </div>
                                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg opacity-50">
                                            <h4 class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-3">v1.0 初始版本</h4>
                                            <ul class="list-disc pl-5 text-gray-600 dark:text-gray-400 space-y-1">
                                                <li>基礎遊戲功能上線</li>
                                                <li>支持多篇文言文背誦</li>
                                                <li>支持分段練習</li>
                                            </ul>
                                        </div>
                                    </div>
                                `;
                                infoModal.classList.remove('hidden');
                                console.log("已顯示版本資訊");
                                
                            } else if (section === 'achievements') {
                                // 顯示歷史成就
                                infoModalTitle.textContent = '歷史成就';
                                
                                // 確保顯示成就函數已定義
                                if (typeof displayAchievements !== 'function') {
                                    console.error("displayAchievements函數未定義");
                                    infoModalContent.innerHTML = `
                                        <div class="text-center p-4">
                                            <i class="fas fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                                            <p class="text-gray-700 dark:text-gray-300">系統錯誤：無法顯示成就功能</p>
                                        </div>
                                    `;
                                } else {
                                    // 先顯示加載訊息
                                    infoModalContent.innerHTML = `
                                        <div class="text-center p-4">
                                            <i class="fas fa-spinner fa-spin text-amber-500 text-3xl mb-3"></i>
                                            <p class="text-gray-700 dark:text-gray-300">載入成就中...</p>
                                        </div>
                                    `;
                                    
                                    // 確保模態框先顯示
                                    infoModal.classList.remove('hidden');
                                    
                                    // 使用setTimeout讓UI先更新，再調用顯示成就函數
                                    setTimeout(() => {
                                        try {
                                            displayAchievements();
                                            console.log("已顯示歷史成就");
                                        } catch (err) {
                                            console.error("顯示成就時發生錯誤:", err);
                                            infoModalContent.innerHTML = `
                                                <div class="text-center p-4">
                                                    <i class="fas fa-exclamation-triangle text-amber-500 text-3xl mb-3"></i>
                                                    <p class="text-gray-700 dark:text-gray-300">載入成就時發生錯誤</p>
                                                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">${err.message}</p>
                                                </div>
                                            `;
                                        }
                                    }, 50);
                                }
                            } else if (section === 'about') {
                                // 關於製作者 - 顯示製作者相關信息
                                infoModalTitle.textContent = '關於製作者';
                                infoModalContent.innerHTML = `
                                    <div class="space-y-4">
                                        <div class="flex flex-col items-center mb-4">
                                            <div class="w-20 h-20 bg-amber-100 dark:bg-amber-800 rounded-full flex items-center justify-center text-2xl text-amber-800 dark:text-amber-100 mb-2">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <h3 class="text-lg font-medium">@chl____chl</h3>
                                            <p class="text-gray-500 dark:text-gray-400 text-sm">文言文背誦大師之旅 開發者</p>
                                        </div>
                                        
                                        <p class="text-gray-700 dark:text-gray-300">
                                            熱愛中國傳統文化，致力於設計能夠幫助學生輕鬆記憶文言文的學習工具。本應用旨在通過遊戲化方式，讓背誦文言文變得有趣且富有成就感。
                                        </p>
                                        
                                        <p class="text-gray-700 dark:text-gray-300">
                                            期望通過這款應用，能夠讓更多同學愛上中國文學經典，感受文言文的魅力。未來將持續更新內容，歡迎提供寶貴建議！
                                        </p>
                                        
                                        <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                            <p class="text-gray-600 dark:text-gray-400 text-sm text-center">
                                                "學而時習之，不亦說乎？" <br>
                                                ---- 《論語·學而》
                                            </p>
                                        </div>
                                    </div>
                                `;
                                infoModal.classList.remove('hidden');
                                console.log("已顯示關於製作者");
                            }
                        } catch (err) {
                            console.error("設置選項點擊處理發生錯誤:", err);
                            alert("發生錯誤，請檢查控制台以獲取詳細信息");
                        }
                    });
                });
            }
            
            // 初始化本地存儲功能
            function initializeLocalStorage() {
                // 檢查是否支持localStorage
                if (typeof(Storage) === "undefined") {
                    console.log("瀏覽器不支持localStorage");
                    return;
                }
                
                try {
                    // 從localStorage載入用戶記錄
                    if (localStorage.getItem('userRecords')) {
                        try {
                            userRecordsMemory = JSON.parse(localStorage.getItem('userRecords'));
                            console.log("從localStorage載入記錄成功:", Object.keys(userRecordsMemory).length, "個記錄");
                        } catch (e) {
                            console.error("解析userRecords時出錯:", e);
                            userRecordsMemory = {};
                            localStorage.setItem('userRecords', JSON.stringify({}));
                        }
                    } else {
                        userRecordsMemory = {};
                        localStorage.setItem('userRecords', JSON.stringify({}));
                        console.log("初始化userRecords本地存儲");
                    }
                    
                    // 從localStorage載入全局統計數據
                    if (localStorage.getItem('globalStats')) {
                        try {
                            globalStats = JSON.parse(localStorage.getItem('globalStats'));
                            console.log("從localStorage載入統計數據成功");
                        } catch (e) {
                            console.error("解析globalStats時出錯:", e);
                            initializeDefaultStats();
                        }
                    } else {
                        // 使用默認全局統計數據
                        initializeDefaultStats();
                        console.log("初始化globalStats本地存儲");
                    }
                } catch (error) {
                    console.error("載入本地存儲數據時出錯:", error);
                    // 初始化默認數據
                    userRecordsMemory = {};
                    initializeDefaultStats();
                }
            }
            
            // 初始化默認統計數據
            function initializeDefaultStats() {
                globalStats = {
                    totalCompletionCount: 0,
                    failAfterHalfwayCount: 0,
                    lightningAchievementCount: 0,
                    perfectAchievementCount: 0,
                    memoryAchievementCount: 0,
                    tirelessAchievementCount: 0,
                    nightOwlAchievementCount: 0,
                    badDigestionAchievementCount: 0,
                    achievements: {
                        nightOwl: false,
                        badDigestion: false,
                        dryEyes: false,
                        nightOwlKing: false,
                        focusOnEating: false,
                        adventureLevel: 0,
                        defeatLevel: 0,
                        speedRouteLevel: 0,
                        perfectRouteLevel: 0,
                        memoryRouteLevel: 0
                    }
                };
                
                try {
                    localStorage.setItem('globalStats', JSON.stringify(globalStats));
                } catch (e) {
                    console.error("保存默認統計數據時出錯:", e);
                }
            }
            
            // 保存統計數據到localStorage
            function saveStats() {
                if (typeof(Storage) === "undefined") {
                    console.log("瀏覽器不支持localStorage, 無法保存數據");
                    return;
                }
                
                try {
                    // 保存用戶記錄
                    localStorage.setItem('userRecords', JSON.stringify(userRecordsMemory));
                    
                    // 保存全局統計
                    localStorage.setItem('globalStats', JSON.stringify(globalStats));
                    
                    console.log("數據已成功保存到localStorage");
                } catch (error) {
                    console.error("保存數據到localStorage時出錯:", error);
                }
            }
            
            // 顯示用戶記錄 - 改良版 (包含未完成篇章)
            function displayUserRecords() {
                const infoModalContent = document.getElementById('info-modal-content');
                if (!infoModalContent) return;
                
                // 使用內存中的記錄
                const hasRecords = Object.keys(userRecordsMemory).length > 0;
                
                // 定義分類順序
                const categoryOrder = ['中一', '中二', '中三', '指定文言', '文學', '其他'];
                
                // 分類選擇器
                let recordsHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-lg font-medium text-amber-800 dark:text-amber-400">按分類查看</h4>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="category-filter py-1 px-3 bg-primary text-white rounded-lg hover:bg-opacity-90 text-sm" data-category="all">全部</button>
                `;
                
                // 分類所有篇章，包括尚未完成的
                const categorizedPassages = {};
                
                // 先將所有篇章按分類整理
                Object.keys(passages).forEach(passageKey => {
                    const passage = passages[passageKey];
                    const category = passage.category || '其他';
                    
                    if (!categorizedPassages[category]) {
                        categorizedPassages[category] = [];
                    }
                    
                    // 檢查是否有記錄
                    const record = userRecordsMemory[passageKey] || null;
                    
                    categorizedPassages[category].push({
                        passageKey,
                        title: passage.title,
                        author: passage.author,
                        category: category,
                        record: record,
                        hasRecord: !!record
                    });
                });
                
                // 為每個有篇章的分類創建篩選按鈕
                categoryOrder.forEach(category => {
                    if (categorizedPassages[category] && categorizedPassages[category].length > 0) {
                        recordsHTML += `
                            <button class="category-filter py-1 px-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-sm" data-category="${category}">
                                ${category}
                            </button>
                        `;
                    }
                });
                
                recordsHTML += `</div></div>`;
                
                // 如果完全沒有篇章記錄
                if (Object.keys(categorizedPassages).length === 0) {
                    recordsHTML += `
                        <div class="text-center p-4">
                            <i class="fas fa-info-circle text-amber-500 text-3xl mb-3"></i>
                            <p class="text-gray-700 dark:text-gray-300">尚未加載任何篇章</p>
                        </div>
                    `;
                    infoModalContent.innerHTML = recordsHTML;
                    return;
                }
                
                recordsHTML += `<div class="space-y-4 records-container">`;
                
                // 按照預定義順序處理分類
                categoryOrder.forEach(category => {
                    if (categorizedPassages[category] && categorizedPassages[category].length > 0) {
                        recordsHTML += `
                            <div class="category-section mb-4" data-category="${category}">
                                <h4 class="text-lg font-medium text-amber-800 dark:text-amber-400 mb-2">${category}</h4>
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg overflow-hidden">
                        `;
                        
                        // 對該分類中的所有篇章按標題排序
                        categorizedPassages[category].sort((a, b) => {
                            if (a.title < b.title) return -1;
                            if (a.title > b.title) return 1;
                            return 0;
                        });
                        
                        // 生成該分類下的所有篇章記錄 (包括未完成的)
                        categorizedPassages[category].forEach((item, index) => {
                            // 判斷是否有記錄
                            if (item.hasRecord) {
                                // 格式化最佳時間
                                let bestTimeFormatted = "未有記錄";
                                if (item.record.bestTime) {
                                    const minutes = Math.floor(item.record.bestTime / 60);
                                    const seconds = (item.record.bestTime % 60).toFixed(1);
                                    bestTimeFormatted = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(4, '0')}`;
                                }
                                
                                recordsHTML += `
                                    <div class="p-3 ${index > 0 ? 'border-t border-gray-200 dark:border-gray-600' : ''}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-800 dark:text-gray-200">${item.title}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">${item.author}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-gray-700 dark:text-gray-300">完成：<span class="font-medium">${item.record.completionCount || 0}</span> 次</p>
                                                <p class="text-gray-700 dark:text-gray-300">最佳：<span class="font-medium">${bestTimeFormatted}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // 顯示未完成的篇章
                                recordsHTML += `
                                    <div class="p-3 ${index > 0 ? 'border-t border-gray-200 dark:border-gray-600' : ''} bg-gray-50 dark:bg-gray-800/30">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-600 dark:text-gray-400">${item.title}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-500">${item.author}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-amber-600 dark:text-amber-500 italic text-sm">未有記錄</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        recordsHTML += `</div></div>`;
                    }
                });
                
                recordsHTML += `</div>`;
                
                infoModalContent.innerHTML = recordsHTML;
                
                // 為分類篩選按鈕添加事件監聽器
                setTimeout(() => {
                    const categoryFilters = infoModalContent.querySelectorAll('.category-filter');
                    const categorySections = infoModalContent.querySelectorAll('.category-section');
                    
                    categoryFilters.forEach(filter => {
                        filter.addEventListener('click', function() {
                            // 移除所有按鈕的高亮樣式
                            categoryFilters.forEach(btn => {
                                btn.classList.remove('bg-primary', 'text-white');
                                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                            });
                            
                            // 高亮當前選中的按鈕
                            this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                            this.classList.add('bg-primary', 'text-white');
                            
                            // 獲取選中的分類
                            const selectedCategory = this.dataset.category;
                            
                            // 顯示/隱藏相應的分類板塊
                            if (selectedCategory === 'all') {
                                // 顯示所有分類
                                categorySections.forEach(section => {
                                    section.style.display = 'block';
                                });
                            } else {
                                // 只顯示選中的分類
                                categorySections.forEach(section => {
                                    if (section.dataset.category === selectedCategory) {
                                        section.style.display = 'block';
                                    } else {
                                        section.style.display = 'none';
                                    }
                                });
                            }
                        });
                    });
                    
                    // 默認選中"全部"按鈕
                    const allFilter = infoModalContent.querySelector('.category-filter[data-category="all"]');
                    if (allFilter) {
                        allFilter.click();
                    }
                }, 100);
            }
            
            // 用於替代localStorage的內存存儲
            let userRecordsMemory = {};
            
            // 全局成就和統計跟踪
            let globalStats = {
                totalCompletionCount: 0,      // 總完成次數
                failAfterHalfwayCount: 0,     // 遊戲過半後失敗次數
                lightningAchievementCount: 0, // 獲得閃電俠成就次數
                perfectAchievementCount: 0,   // 獲得完美無瑕成就次數
                memoryAchievementCount: 0,    // 獲得記憶大師成就次數
                tirelessAchievementCount: 0,  // 獲得不知疲倦成就次數
                nightOwlAchievementCount: 0,  // 獲得夜貓成就次數
                badDigestionAchievementCount: 0, // 獲得腸胃不好成就次數
                achievements: {
                    // 特殊時間成就
                    nightOwl: false,         // 夜貓（01:00-03:00完成）
                    badDigestion: false,     // 腸胃不好（11:59-12:45完成）
                    
                    // 特殊累積成就
                    dryEyes: false,          // 眼乾（獲得「不知疲倦」30次）
                    nightOwlKing: false,     // 夜貓王（獲得「夜貓」20次）
                    focusOnEating: false,    // 請專心吃飯（獲得「腸胃不好」20次）
                    
                    // 冒險之路成就
                    adventureLevel: 0,       // 0:未獲得 1:初心者 2:勇者 3:大師 4:偏執狂 5:掃地僧
                    
                    // 挫敗之路成就
                    defeatLevel: 0,          // 0:未獲得 1:初嘗敗績 2:堅毅 3:鋼鐵意志 4:小強是我 5:心如止水
                    
                    // 極速之路成就
                    speedRouteLevel: 0,      // 0:未獲得 1:敏捷 2:肌肉記憶 3:無影手 4:世界第一束光
                    
                    // 完美之路成就
                    perfectRouteLevel: 0,     // 0:未獲得 1:如沐春風 2:完美主義 3:滿月 4:至善
                    
                    // 記憶之路成就
                    memoryRouteLevel: 0       // 0:未獲得 1:激活腦細胞 2:記憶麵包 3:移動圖書館 4:流如背倒
                }
            };
            
            // 記錄通關成績
            function recordCompletionStats(passageKey, completionTime, isFullPassage) {
                // 只記錄完整篇章的成績
                if (!isFullPassage) {
                    console.log("非完整篇章，不記錄成績");
                    return;
                }
                
                try {
                    // 確保userRecordsMemory已初始化
                    if (typeof userRecordsMemory !== 'object' || userRecordsMemory === null) {
                        userRecordsMemory = {};
                        console.log("初始化userRecordsMemory");
                    }
                    
                    // 確保globalStats已初始化
                    if (typeof globalStats !== 'object' || globalStats === null) {
                        initializeDefaultStats();
                    }
                    
                    // 更新記錄
                    if (!userRecordsMemory[passageKey]) {
                        userRecordsMemory[passageKey] = {
                            completionCount: 0,
                            bestTime: null
                        };
                    }
                    
                    // 增加完成次數
                    userRecordsMemory[passageKey].completionCount = (userRecordsMemory[passageKey].completionCount || 0) + 1;
                    
                    // 更新全局完成次數
                    globalStats.totalCompletionCount = (globalStats.totalCompletionCount || 0) + 1;
                    
                    // 更新冒險之路成就
                    if (globalStats.totalCompletionCount >= 500 && globalStats.achievements.adventureLevel < 5) {
                        globalStats.achievements.adventureLevel = 5; // 掃地僧
                    } else if (globalStats.totalCompletionCount >= 300 && globalStats.achievements.adventureLevel < 4) {
                        globalStats.achievements.adventureLevel = 4; // 偏執狂
                    } else if (globalStats.totalCompletionCount >= 100 && globalStats.achievements.adventureLevel < 3) {
                        globalStats.achievements.adventureLevel = 3; // 大師
                    } else if (globalStats.totalCompletionCount >= 10 && globalStats.achievements.adventureLevel < 2) {
                        globalStats.achievements.adventureLevel = 2; // 勇者
                    } else if (globalStats.totalCompletionCount >= 1 && globalStats.achievements.adventureLevel < 1) {
                        globalStats.achievements.adventureLevel = 1; // 初心者
                    }
                    
                    // 檢查特殊時間成就
                    const now = new Date();
                    const hours = now.getHours();
                    const minutes = now.getMinutes();
                    
                    // 判斷夜貓成就 (01:00-03:00)
                    if (hours >= 1 && hours < 3) {
                        globalStats.achievements.nightOwl = true;
                        
                        // 增加獲得夜貓成就次數
                        globalStats.nightOwlAchievementCount = (globalStats.nightOwlAchievementCount || 0) + 1;
                        
                        // 檢查是否達成「夜貓王」成就（獲得夜貓20次）
                        if (globalStats.nightOwlAchievementCount >= 20 && !globalStats.achievements.nightOwlKing) {
                            globalStats.achievements.nightOwlKing = true;
                            console.log("獲得獨立成就：夜貓王（獲得夜貓20次）");
                        }
                    }
                    
                    // 判斷腸胃不好成就 (11:59-12:45)
                    if ((hours == 11 && minutes >= 59) || (hours == 12 && minutes <= 45)) {
                        globalStats.achievements.badDigestion = true;
                        
                        // 增加獲得腸胃不好成就次數
                        globalStats.badDigestionAchievementCount = (globalStats.badDigestionAchievementCount || 0) + 1;
                        
                        // 檢查是否達成「請專心吃飯」成就（獲得腸胃不好20次）
                        if (globalStats.badDigestionAchievementCount >= 20 && !globalStats.achievements.focusOnEating) {
                            globalStats.achievements.focusOnEating = true;
                            console.log("獲得獨立成就：請專心吃飯（獲得腸胃不好20次）");
                        }
                    }
                    
                    // 更新最佳時間（如果比現有記錄更好或沒有記錄）
                    if (userRecordsMemory[passageKey].bestTime === null || completionTime < userRecordsMemory[passageKey].bestTime) {
                        userRecordsMemory[passageKey].bestTime = completionTime;
                    }
                    
                    // 保存更新後的數據到localStorage
                    saveStats();
                    
                    console.log(`更新記錄：${passageKey}，完成次數: ${userRecordsMemory[passageKey].completionCount}, 最佳時間: ${userRecordsMemory[passageKey].bestTime}`);
                    console.log("當前記錄數據：", JSON.stringify(userRecordsMemory));
                    console.log("全局統計：", JSON.stringify(globalStats));
                } catch (e) {
                    console.error('記錄成績時發生錯誤', e);
                }
            }
            
            // 顯示歷史成就
function displayAchievements() {
    const infoModalContent = document.getElementById('info-modal-content');
    if (!infoModalContent) return;
    
    // 確保globalStats已初始化
    if (typeof globalStats !== 'object' || globalStats === null) {
        initializeDefaultStats();
    }
    
    // 創建SVG徽章
    const createAchievementSVG = (colors, borderColor) => {
        const uniqueId = 'seal_' + Math.random().toString(36).substr(2, 9);
        return `
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="${uniqueId}" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                    <stop offset="0%" style="stop-color:${colors.center}" />
                    <stop offset="70%" style="stop-color:${colors.middle}" />
                    <stop offset="100%" style="stop-color:${colors.outer}" />
                </radialGradient>
            </defs>
            <circle cx="50" cy="50" r="45" fill="url(#${uniqueId})" />
            <circle cx="50" cy="50" r="42" fill="none" stroke="${borderColor}" stroke-width="1" stroke-dasharray="2,1" />
            <circle cx="50" cy="50" r="38" fill="none" stroke="${borderColor}" stroke-width="0.5" />
        </svg>
        `;
    };
    
    // 各成就顏色定義
    // 冒險之路成就顏色
    const adventureColors = [
        { center: '#90CAF9', middle: '#64B5F6', outer: '#42A5F5' }, // 初心者
        { center: '#81C784', middle: '#66BB6A', outer: '#4CAF50' }, // 勇者
        { center: '#FF8A65', middle: '#FF7043', outer: '#F4511E' }, // 大師
        { center: '#9575CD', middle: '#7E57C2', outer: '#673AB7' }, // 偏執狂
        { center: '#FFD54F', middle: '#FFCA28', outer: '#FFC107' }  // 掃地僧
    ];
    
    // 挫敗之路成就顏色
    const defeatColors = [
        { center: '#B39DDB', middle: '#9575CD', outer: '#7E57C2' }, // 初嘗敗績
        { center: '#90CAF9', middle: '#64B5F6', outer: '#42A5F5' }, // 堅毅
        { center: '#26A69A', middle: '#009688', outer: '#00796B' }, // 鋼鐵意志
        { center: '#FFA726', middle: '#FF9800', outer: '#F57C00' }, // 小強是我
        { center: '#EF5350', middle: '#F44336', outer: '#D32F2F' }  // 心如止水
    ];
    
    // 極速之路成就顏色
    const speedColors = [
        { center: '#5E35B1', middle: '#4527A0', outer: '#311B92' }, // 敏捷
        { center: '#3949AB', middle: '#303F9F', outer: '#283593' }, // 肌肉記憶
        { center: '#1E88E5', middle: '#1976D2', outer: '#1565C0' }, // 無影手
        { center: '#039BE5', middle: '#0288D1', outer: '#0277BD' }  // 世界第一束光
    ];
    
    // 完美之路成就顏色
    const perfectColors = [
        { center: '#D81B60', middle: '#C2185B', outer: '#AD1457' }, // 如沐春風
        { center: '#8E24AA', middle: '#7B1FA2', outer: '#6A1B9A' }, // 完美主義
        { center: '#5E35B1', middle: '#512DA8', outer: '#4527A0' }, // 滿月
        { center: '#3949AB', middle: '#303F9F', outer: '#283593' }  // 至善
    ];
    
    // 記憶之路成就顏色
    const memoryColors = [
        { center: '#00796B', middle: '#00695C', outer: '#004D40' }, // 激活腦細胞
        { center: '#00ACC1', middle: '#0097A7', outer: '#00838F' }, // 記憶麵包
        { center: '#43A047', middle: '#388E3C', outer: '#2E7D32' }, // 移動圖書館
        { center: '#7CB342', middle: '#689F38', outer: '#558B2F' }  // 流如背倒
    ];
    
    // 特殊累積成就顏色
    const dryEyesColors = { center: '#0288D1', middle: '#0277BD', outer: '#01579B' }; // 眼乾
    const nightOwlKingColors = { center: '#3E2723', middle: '#3E2723', outer: '#3E2723' }; // 夜貓王
    const focusOnEatingColors = { center: '#BF360C', middle: '#BF360C', outer: '#BF360C' }; // 請專心吃飯
    
    let contentHTML = `
    <div class="space-y-6">
        <!-- 冒險之路成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">冒險之路</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
    `;
    
    // 冒險之路成就等級名稱
    const adventureLevels = ['初心者', '勇者', '大師', '偏執狂', '掃地僧'];
    const adventureRequirements = [1, 10, 100, 300, 500];
    const adventureBorderColors = ['#90CAF9', '#4CAF50', '#F4511E', '#673AB7', '#FFC107'];
    
    // 當前冒險等級
    const currentLevel = globalStats.achievements.adventureLevel;
    
    // 如果已經達成任何等級
    if (currentLevel > 0) {
        // 顯示當前等級成就
        const levelIndex = currentLevel - 1;
        contentHTML += `
            <div class="flex items-center mb-6">
                <div class="achievement-seal" style="width: 120px; height: 120px;">
                    ${createAchievementSVG(adventureColors[levelIndex], adventureBorderColors[levelIndex])}
                    <div class="seal-text">
                        <span class="seal-title text-lg">${adventureLevels[levelIndex]}</span>
                        <span class="seal-desc">完成${adventureRequirements[levelIndex]}次</span>
                    </div>
                </div>
                <div class="ml-5">
                    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">目前等級：${adventureLevels[levelIndex]}</p>
                    <p class="text-gray-600 dark:text-gray-400">總完成次數：${globalStats.totalCompletionCount}</p>
        `;
        
        // 如果還有下一等級，顯示進度
        if (currentLevel < 5) {
            const nextLevelIndex = currentLevel;
            const nextRequirement = adventureRequirements[nextLevelIndex];
            const progress = Math.min(100, (globalStats.totalCompletionCount / nextRequirement) * 100);
            
            contentHTML += `
                    <div class="mt-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">距離 "${adventureLevels[nextLevelIndex]}" 還需 ${nextRequirement - globalStats.totalCompletionCount} 次</p>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
            `;
        } else {
            contentHTML += `
                    <p class="mt-3 text-sm text-green-500 dark:text-green-400"><i class="fas fa-crown mr-1"></i> 已達成最高等級！</p>
            `;
        }
        
        contentHTML += `
                </div>
            </div>
        `;
    } else {
        // 顯示尚未獲得任何成就的提示
        contentHTML += `
            <div class="text-center py-8">
                <i class="fas fa-medal text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">尚未獲得冒險成就</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">完成至少1次挑戰解鎖「初心者」成就</p>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
        </div>
        
        <!-- 挫敗之路成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">挫敗之路</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
    `;
    
    // 挫敗之路成就等級名稱
    const defeatLevels = ['初嘗敗績', '堅毅', '鋼鐵意志', '小強是我', '心如止水'];
    const defeatRequirements = [1, 10, 50, 100, 200];
    const defeatBorderColors = ['#7E57C2', '#42A5F5', '#00796B', '#F57C00', '#D32F2F'];
    
    // 當前挫敗等級
    const currentDefeatLevel = globalStats.achievements.defeatLevel;
    
    // 如果已經達成任何等級
    if (currentDefeatLevel > 0) {
        // 顯示當前等級成就
        const levelIndex = currentDefeatLevel - 1;
        contentHTML += `
            <div class="flex items-center mb-6">
                <div class="achievement-seal" style="width: 120px; height: 120px;">
                    ${createAchievementSVG(defeatColors[levelIndex], defeatBorderColors[levelIndex])}
                    <div class="seal-text">
                        <span class="seal-title text-lg">${defeatLevels[levelIndex]}</span>
                        <span class="seal-desc">失敗${defeatRequirements[levelIndex]}次</span>
                    </div>
                </div>
                <div class="ml-5">
                    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">目前等級：${defeatLevels[levelIndex]}</p>
                    <p class="text-gray-600 dark:text-gray-400">遊戲過半後失敗：${globalStats.failAfterHalfwayCount}次</p>
        `;
        
        // 如果還有下一等級，顯示進度
        if (currentDefeatLevel < 5) {
            const nextLevelIndex = currentDefeatLevel;
            const nextRequirement = defeatRequirements[nextLevelIndex];
            const progress = Math.min(100, (globalStats.failAfterHalfwayCount / nextRequirement) * 100);
            
            contentHTML += `
                    <div class="mt-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">距離 "${defeatLevels[nextLevelIndex]}" 還需 ${nextRequirement - globalStats.failAfterHalfwayCount} 次</p>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
            `;
        } else {
            contentHTML += `
                    <p class="mt-3 text-sm text-green-500 dark:text-green-400"><i class="fas fa-crown mr-1"></i> 已達成最高等級！</p>
            `;
        }
        
        contentHTML += `
                </div>
            </div>
        `;
    } else {
        // 顯示尚未獲得任何成就的提示
        contentHTML += `
            <div class="text-center py-8">
                <i class="fas fa-bolt-lightning text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">尚未獲得挫敗成就</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">在遊戲過半後失敗至少1次解鎖「初嘗敗績」成就</p>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
        </div>
        
        <!-- 極速之路成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">極速之路</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
    `;
    
    // 極速之路成就等級名稱
    const speedLevels = ['敏捷', '肌肉記憶', '無影手', '世界第一束光'];
    const speedRequirements = [1, 10, 50, 100];
    const speedBorderColors = ['#311B92', '#283593', '#1565C0', '#0277BD'];
    
    // 當前極速等級
    const currentSpeedLevel = globalStats.achievements.speedRouteLevel;
    
    // 如果已經達成任何等級
    if (currentSpeedLevel > 0) {
        // 顯示當前等級成就
        const levelIndex = currentSpeedLevel - 1;
        contentHTML += `
            <div class="flex items-center mb-6">
                <div class="achievement-seal" style="width: 120px; height: 120px;">
                    ${createAchievementSVG(speedColors[levelIndex], speedBorderColors[levelIndex])}
                    <div class="seal-text">
                        <span class="seal-title text-lg">${speedLevels[levelIndex]}</span>
                        <span class="seal-desc">獲得${speedRequirements[levelIndex]}次</span>
                    </div>
                </div>
                <div class="ml-5">
                    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">目前等級：${speedLevels[levelIndex]}</p>
                    <p class="text-gray-600 dark:text-gray-400">閃電俠成就獲得次數：${globalStats.lightningAchievementCount}次</p>
        `;
        
        // 如果還有下一等級，顯示進度
        if (currentSpeedLevel < 4) {
            const nextLevelIndex = currentSpeedLevel;
            const nextRequirement = speedRequirements[nextLevelIndex];
            const progress = Math.min(100, (globalStats.lightningAchievementCount / nextRequirement) * 100);
            
            contentHTML += `
                    <div class="mt-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">距離 "${speedLevels[nextLevelIndex]}" 還需 ${nextRequirement - globalStats.lightningAchievementCount} 次</p>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
            `;
        } else {
            contentHTML += `
                    <p class="mt-3 text-sm text-green-500 dark:text-green-400"><i class="fas fa-crown mr-1"></i> 已達成最高等級！</p>
            `;
        }
        
        contentHTML += `
                </div>
            </div>
        `;
    } else {
        // 顯示尚未獲得任何成就的提示
        contentHTML += `
            <div class="text-center py-8">
                <i class="fas fa-bolt text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">尚未獲得極速成就</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">獲得「閃電俠」成就至少1次解鎖「敏捷」成就</p>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
        </div>
        
        <!-- 完美之路成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">完美之路</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
    `;
    
    // 完美之路成就等級名稱
    const perfectLevels = ['如沐春風', '完美主義', '滿月', '至善'];
    const perfectRequirements = [1, 10, 50, 100];
    const perfectBorderColors = ['#AD1457', '#6A1B9A', '#4527A0', '#283593'];
    
    // 當前完美等級
    const currentPerfectLevel = globalStats.achievements.perfectRouteLevel;
    
    // 如果已經達成任何等級
    if (currentPerfectLevel > 0) {
        // 顯示當前等級成就
        const levelIndex = currentPerfectLevel - 1;
        contentHTML += `
            <div class="flex items-center mb-6">
                <div class="achievement-seal" style="width: 120px; height: 120px;">
                    ${createAchievementSVG(perfectColors[levelIndex], perfectBorderColors[levelIndex])}
                    <div class="seal-text">
                        <span class="seal-title text-lg">${perfectLevels[levelIndex]}</span>
                        <span class="seal-desc">獲得${perfectRequirements[levelIndex]}次</span>
                    </div>
                </div>
                <div class="ml-5">
                    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">目前等級：${perfectLevels[levelIndex]}</p>
                    <p class="text-gray-600 dark:text-gray-400">完美無瑕成就獲得次數：${globalStats.perfectAchievementCount}次</p>
        `;
        
        // 如果還有下一等級，顯示進度
        if (currentPerfectLevel < 4) {
            const nextLevelIndex = currentPerfectLevel;
            const nextRequirement = perfectRequirements[nextLevelIndex];
            const progress = Math.min(100, (globalStats.perfectAchievementCount / nextRequirement) * 100);
            
            contentHTML += `
                    <div class="mt-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">距離 "${perfectLevels[nextLevelIndex]}" 還需 ${nextRequirement - globalStats.perfectAchievementCount} 次</p>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
            `;
        } else {
            contentHTML += `
                    <p class="mt-3 text-sm text-green-500 dark:text-green-400"><i class="fas fa-crown mr-1"></i> 已達成最高等級！</p>
            `;
        }
        
        contentHTML += `
                </div>
            </div>
        `;
    } else {
        // 顯示尚未獲得任何成就的提示
        contentHTML += `
            <div class="text-center py-8">
                <i class="fas fa-gem text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">尚未獲得完美成就</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">獲得「完美無瑕」成就至少1次解鎖「如沐春風」成就</p>
            </div>
        `;
    }
    
    contentHTML += `
            </div>
        </div>
        
        <!-- 記憶之路成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">記憶之路</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
    `;
    
    // 記憶之路成就等級名稱
    const memoryLevels = ['激活腦細胞', '記憶麵包', '移動圖書館', '流如背倒'];
    const memoryRequirements = [1, 20, 50, 80];
    const memoryBorderColors = ['#004D40', '#00838F', '#2E7D32', '#558B2F'];
    
    // 當前記憶等級
    const currentMemoryLevel = globalStats.achievements.memoryRouteLevel;
    
    // 如果已經達成任何等級
    if (currentMemoryLevel > 0) {
        // 顯示當前等級成就
        const levelIndex = currentMemoryLevel - 1;
        contentHTML += `
            <div class="flex items-center mb-6">
                <div class="achievement-seal" style="width: 120px; height: 120px;">
                    ${createAchievementSVG(memoryColors[levelIndex], memoryBorderColors[levelIndex])}
                    <div class="seal-text">
                        <span class="seal-title text-lg">${memoryLevels[levelIndex]}</span>
                        <span class="seal-desc">獲得${memoryRequirements[levelIndex]}次</span>
                    </div>
                </div>
                <div class="ml-5">
                    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">目前等級：${memoryLevels[levelIndex]}</p>
                    <p class="text-gray-600 dark:text-gray-400">記憶大師成就獲得次數：${globalStats.memoryAchievementCount}次</p>
        `;
        
        // 如果還有下一等級，顯示進度
        if (currentMemoryLevel < 4) {
            const nextLevelIndex = currentMemoryLevel;
            const nextRequirement = memoryRequirements[nextLevelIndex];
            const progress = Math.min(100, (globalStats.memoryAchievementCount / nextRequirement) * 100);
            
            contentHTML += `
                    <div class="mt-3">
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">距離 "${memoryLevels[nextLevelIndex]}" 還需 ${nextRequirement - globalStats.memoryAchievementCount} 次</p>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
            `;
        } else {
            contentHTML += `
                    <p class="mt-3 text-sm text-green-500 dark:text-green-400"><i class="fas fa-crown mr-1"></i> 已達成最高等級！</p>
            `;
        }
        
        contentHTML += `
                </div>
            </div>
        `;
    } else {
        // 顯示尚未獲得任何成就的提示
        contentHTML += `
            <div class="text-center py-8">
                <i class="fas fa-brain text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                <p class="text-gray-600 dark:text-gray-400">尚未獲得記憶成就</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">獲得「記憶大師」成就至少1次解鎖「激活腦細胞」成就</p>
            </div>
        `;
    }
    
    // 特殊成就
    contentHTML += `
            </div>
        </div>
        
        <!-- 特殊成就 -->
        <div>
            <h4 class="text-xl font-bold text-amber-700 dark:text-amber-400 mb-4">特殊成就</h4>
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-5">
                <div class="space-y-4">
    `;
    
    // 眼乾成就 (獲得不知疲倦30次)
    if (globalStats.achievements.dryEyes) {
        contentHTML += `
            <div class="flex items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div class="achievement-seal" style="width: 80px; height: 80px; margin: 0 10px 0 0;">
                    ${createAchievementSVG(dryEyesColors, '#0277BD')}
                    <div class="seal-text">
                        <span class="seal-title">眼乾</span>
                        <span class="seal-desc text-[8px]">不暫停成癮</span>
                    </div>
                </div>
                <div class="ml-3">
                    <p class="font-medium text-gray-800 dark:text-gray-200">眼乾</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">獲得不知疲倦30次</p>
                    <p class="text-xs text-green-500 dark:text-green-400 mt-1"><i class="fas fa-check-circle mr-1"></i> 已獲得</p>
                </div>
            </div>
        `;
    } else {
        contentHTML += `
            <div class="flex items-center p-4 bg-gray-100 dark:bg-gray-700/40 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3">
                    <i class="fas fa-eye text-gray-400 dark:text-gray-500"></i>
                </div>
                <div>
                    <p class="font-medium text-gray-500 dark:text-gray-400">眼乾</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">獲得「不知疲倦」30次</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"><i class="fas fa-lock mr-1"></i> 未解鎖</p>
                </div>
            </div>
        `;
    }
    
    // 夜貓王成就 (獲得夜貓20次)
    if (globalStats.achievements.nightOwlKing) {
        contentHTML += `
            <div class="flex items-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                <div class="achievement-seal" style="width: 80px; height: 80px; margin: 0 10px 0 0;">
                    ${createAchievementSVG(nightOwlKingColors, '#5D4037')}
                    <div class="seal-text">
                        <span class="seal-title">夜貓王</span>
                        <span class="seal-desc text-[8px]">深夜成癮</span>
                    </div>
                </div>
                <div class="ml-3">
                    <p class="font-medium text-gray-800 dark:text-gray-200">夜貓王</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">獲得「夜貓」20次</p>
                    <p class="text-xs text-green-500 dark:text-green-400 mt-1"><i class="fas fa-check-circle mr-1"></i> 已獲得</p>
                </div>
            </div>
        `;
    } else {
        contentHTML += `
            <div class="flex items-center p-4 bg-gray-100 dark:bg-gray-700/40 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3">
                    <i class="fas fa-moon text-gray-400 dark:text-gray-500"></i>
                </div>
                <div>
                    <p class="font-medium text-gray-500 dark:text-gray-400">夜貓王</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">獲得「夜貓」20次</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"><i class="fas fa-lock mr-1"></i> 未解鎖</p>
                </div>
            </div>
        `;
    }
    
    // 請專心吃飯成就 (獲得腸胃不好20次)
    if (globalStats.achievements.focusOnEating) {
        contentHTML += `
            <div class="flex items-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                <div class="achievement-seal" style="width: 80px; height: 80px; margin: 0 10px 0 0;">
                    ${createAchievementSVG(focusOnEatingColors, '#E65100')}
                    <div class="seal-text">
                        <span class="seal-title">請專心吃飯</span>
                        <span class="seal-desc text-[8px]">午餐時背誦</span>
                    </div>
                </div>
                <div class="ml-3">
                    <p class="font-medium text-gray-800 dark:text-gray-200">請專心吃飯</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">獲得「腸胃不好」20次</p>
                    <p class="text-xs text-green-500 dark:text-green-400 mt-1"><i class="fas fa-check-circle mr-1"></i> 已獲得</p>
                </div>
            </div>
        `;
    } else {
        contentHTML += `
            <div class="flex items-center p-4 bg-gray-100 dark:bg-gray-700/40 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3">
                    <i class="fas fa-utensils text-gray-400 dark:text-gray-500"></i>
                </div>
                <div>
                    <p class="font-medium text-gray-500 dark:text-gray-400">請專心吃飯</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">獲得「腸胃不好」20次</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1"><i class="fas fa-lock mr-1"></i> 未解鎖</p>
                </div>
            </div>
        `;
    }
    
    contentHTML += `
                </div>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8">
            持續挑戰，解鎖更多成就！
        </div>
    </div>
    `;
    
    infoModalContent.innerHTML = contentHTML;
}            
            console.log("初始化完成");
        });
    </script>
</body>
</html>
